"use strict";

var _typeof = require("@babel/runtime-corejs3/helpers/typeof");

var _WeakMap = require("@babel/runtime-corejs3/core-js-stable/weak-map");

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js-stable/object/define-property");

var _Object$getOwnPropertyDescriptor = require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptor");

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");

_Object$defineProperty(exports, "__esModule", {
  value: true
});

exports["default"] = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime-corejs3/helpers/slicedToArray"));

var _forEach = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/for-each"));

var _map = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/map"));

var _entries = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/entries"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireWildcard(require("react"));

var _Context = _interopRequireDefault(require("./Context"));

var _usePrevious = _interopRequireDefault(require("./usePrevious"));

var _useRefFrom = _interopRequireDefault(require("./useRefFrom"));

var _vendorPrefix = _interopRequireDefault(require("./vendorPrefix"));

function _getRequireWildcardCache(nodeInterop) { if (typeof _WeakMap !== "function") return null; var cacheBabelInterop = new _WeakMap(); var cacheNodeInterop = new _WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { "default": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = _Object$defineProperty && _Object$getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? _Object$getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { _Object$defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/* eslint no-magic-numbers: ["error", { "ignore": [0, 1, 2, 3] }] */
function applyAll() {
  for (var _len = arguments.length, fns = new Array(_len), _key = 0; _key < _len; _key++) {
    fns[_key] = arguments[_key];
  }

  return function () {
    var _arguments = arguments,
        _this = this;

    // eslint-disable-next-line no-invalid-this, prefer-rest-params
    (0, _forEach["default"])(fns).call(fns, function (fn) {
      return fn.apply(_this, _arguments);
    });
  };
}

function recognitionAbortable(recognition) {
  return !!(recognition && typeof recognition.abort === 'function');
}

var Composer = function Composer(_ref) {
  var children = _ref.children,
      extra = _ref.extra,
      grammar = _ref.grammar,
      lang = _ref.lang,
      onDictate = _ref.onDictate,
      onError = _ref.onError,
      onProgress = _ref.onProgress,
      onRawEvent = _ref.onRawEvent,
      speechGrammarList = _ref.speechGrammarList,
      speechRecognition = _ref.speechRecognition,
      started = _ref.started;

  var _useState = (0, _react.useState)(0),
      _useState2 = (0, _slicedToArray2["default"])(_useState, 2),
      readyState = _useState2[0],
      setReadyState = _useState2[1];

  var emitDictateOnEndRef = (0, _react.useRef)(false);
  var extraRef = (0, _useRefFrom["default"])(extra);
  var grammarRef = (0, _useRefFrom["default"])(grammar);
  var langRef = (0, _useRefFrom["default"])(lang);
  var notAllowedRef = (0, _react.useRef)(false);
  var onDictateRef = (0, _useRefFrom["default"])(onDictate);
  var onErrorRef = (0, _useRefFrom["default"])(onError);
  var onProgressRef = (0, _useRefFrom["default"])(onProgress);
  var onRawEventRef = (0, _useRefFrom["default"])(onRawEvent);
  var prevSpeechRecognition = (0, _usePrevious["default"])(speechRecognition);
  var recognitionRef = (0, _react.useRef)();
  var speechGrammarListRef = (0, _useRefFrom["default"])(speechGrammarList);
  var speechRecognitionRef = (0, _useRefFrom["default"])(speechRecognition); // If "speechRecognition" ponyfill changed, reset the "notAllowed" flag.

  if (prevSpeechRecognition !== speechRecognition) {
    notAllowedRef.current = false;
  }

  var handleAudioEnd = (0, _react.useCallback)(function (_ref2) {
    var target = _ref2.target;
    return target === recognitionRef.current && setReadyState(3);
  }, [recognitionRef, setReadyState]);
  var handleAudioStart = (0, _react.useCallback)(function (_ref3) {
    var target = _ref3.target;

    if (target !== recognitionRef.current) {
      return;
    }

    setReadyState(2); // Web Speech API does not emit "result" when nothing is heard, and Chrome does not emit "nomatch" event.
    // Because we emitted onProgress, we should emit "dictate" if not error, so they works in pair.

    emitDictateOnEndRef.current = true;
    onProgressRef.current && onProgressRef.current({
      abortable: recognitionAbortable(target),
      type: 'progress'
    });
  }, [emitDictateOnEndRef, onProgressRef, recognitionRef, setReadyState]);
  var handleEnd = (0, _react.useCallback)(function (_ref4) {
    var target = _ref4.target;

    if (target !== recognitionRef.current) {
      return;
    }

    recognitionRef.current = undefined;
    setReadyState(0);

    if (emitDictateOnEndRef.current) {
      onDictateRef.current && onDictateRef.current({
        type: 'dictate'
      });
      emitDictateOnEndRef.current = false;
    }
  }, [emitDictateOnEndRef, onDictateRef, recognitionRef, setReadyState]);
  var handleError = (0, _react.useCallback)(function (event) {
    if (event.target !== recognitionRef.current) {
      return;
    } // Error out, no need to emit "dictate"


    emitDictateOnEndRef.current = false;
    recognitionRef.current = undefined;

    if (event.error === 'not-allowed') {
      notAllowedRef.current = true;
    }

    setReadyState(0);
    onErrorRef.current && onErrorRef.current(event);
  }, [emitDictateOnEndRef, onErrorRef, notAllowedRef, recognitionRef, setReadyState]);
  var handleRawEvent = (0, _react.useCallback)(function (event) {
    if (event.target !== recognitionRef.current) {
      return;
    }

    onRawEventRef.current && onRawEventRef.current(event);
  }, [onRawEventRef, recognitionRef]);
  var handleResult = (0, _react.useCallback)(function (_ref5) {
    var rawResults = _ref5.results,
        target = _ref5.target;

    if (target !== recognitionRef.current) {
      return;
    }

    if (rawResults.length) {
      var results = (0, _map["default"])([]).call(rawResults, function (alts) {
        // Destructuring breaks Angular due to a bug in Zone.js.
        // eslint-disable-next-line prefer-destructuring
        var firstAlt = alts[0];
        return {
          confidence: firstAlt.confidence,
          transcript: firstAlt.transcript
        };
      }); // Destructuring breaks Angular due to a bug in Zone.js.
      // eslint-disable-next-line prefer-destructuring

      var first = rawResults[0];

      if (first.isFinal) {
        // After "onDictate" callback, the caller should be able to set "started" to false on an unabortable recognition.
        // TODO: Add test for fortification.
        recognitionRef.current = undefined;
        setReadyState(0);
        onDictateRef.current && onDictateRef.current({
          result: results[0],
          type: 'dictate'
        });
      } else {
        onProgressRef.current && onProgressRef.current({
          abortable: recognitionAbortable(target),
          results: results,
          type: 'progress'
        });
      }
    }
  }, [onDictateRef, onProgressRef, recognitionRef, setReadyState]);
  var handleStart = (0, _react.useCallback)(function (_ref6) {
    var target = _ref6.target;
    return target === recognitionRef.current && setReadyState(1);
  }, [recognitionRef, setReadyState]);
  (0, _react.useEffect)(function () {
    if (started) {
      var _context;

      if (!speechRecognitionRef.current || notAllowedRef.current) {
        throw new Error('Speech recognition is not supported');
      }

      var grammars = speechGrammarListRef.current && grammarRef.current && new speechGrammarListRef.current();
      var recognition = recognitionRef.current = new speechRecognitionRef.current();

      if (grammars) {
        grammars.addFromString(grammarRef.current, 1);
        recognition.grammars = grammars;
      }

      recognition.lang = langRef.current;
      recognition.interimResults = true;
      recognition.onaudioend = applyAll(handleAudioEnd, handleRawEvent);
      recognition.onaudiostart = applyAll(handleAudioStart, handleRawEvent);
      recognition.onend = applyAll(handleEnd, handleRawEvent);
      recognition.onerror = applyAll(handleError, handleRawEvent);
      recognition.onnomatch = handleRawEvent;
      recognition.onresult = applyAll(handleResult, handleRawEvent);
      recognition.onsoundend = handleRawEvent;
      recognition.onsoundstart = handleRawEvent;
      recognition.onspeechend = handleRawEvent;
      recognition.onspeechstart = handleRawEvent;
      recognition.onstart = applyAll(handleStart, handleRawEvent);
      var _extra = extraRef.current;
      _extra && (0, _forEach["default"])(_context = (0, _entries["default"])(_extra)).call(_context, function (_ref7) {
        var _ref8 = (0, _slicedToArray2["default"])(_ref7, 2),
            key = _ref8[0],
            value = _ref8[1];

        if (key !== 'constructor' && key !== 'prototype' && key !== '__proto__') {
          recognition[key] = value;
        }
      });
      recognition.start();
    }

    return function () {
      var recognition = recognitionRef.current;

      if (recognition) {
        if (recognitionAbortable(recognition)) {
          recognition.abort();
        } else {
          throw new Error('Failed to stop recognition while the current one is ongoing and is not abortable.');
        }
      }
    };
  }, [extraRef, grammarRef, handleAudioEnd, handleAudioStart, handleEnd, handleError, handleRawEvent, handleResult, handleStart, langRef, notAllowedRef, recognitionRef, speechGrammarListRef, speechRecognitionRef, started]);
  var abortable = recognitionAbortable(recognitionRef.current) && readyState === 2;
  var supported = !!speechRecognition && !notAllowedRef.current;
  var context = (0, _react.useMemo)(function () {
    return {
      abortable: abortable,
      readyState: readyState,
      supported: supported
    };
  }, [abortable, readyState, supported]);
  return /*#__PURE__*/_react["default"].createElement(_Context["default"].Provider, {
    value: context
  }, /*#__PURE__*/_react["default"].createElement(_Context["default"].Consumer, null, function (context) {
    return typeof children === 'function' ? children(context) : children;
  }));
};

Composer.defaultProps = {
  children: undefined,
  extra: undefined,
  grammar: undefined,
  lang: undefined,
  onDictate: undefined,
  onError: undefined,
  onProgress: undefined,
  onRawEvent: undefined,
  speechGrammarList: navigator.mediaDevices && navigator.mediaDevices.getUserMedia && (0, _vendorPrefix["default"])('SpeechGrammarList'),
  speechRecognition: navigator.mediaDevices && navigator.mediaDevices.getUserMedia && (0, _vendorPrefix["default"])('SpeechRecognition'),
  started: undefined
};
Composer.propTypes = {
  children: _propTypes["default"].any,
  extra: _propTypes["default"].any,
  grammar: _propTypes["default"].string,
  lang: _propTypes["default"].string,
  onDictate: _propTypes["default"].func,
  onError: _propTypes["default"].func,
  onProgress: _propTypes["default"].func,
  onRawEvent: _propTypes["default"].func,
  speechGrammarList: _propTypes["default"].any,
  speechRecognition: _propTypes["default"].any,
  started: _propTypes["default"].any
};
var _default = Composer;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Db21wb3Nlci5qcyJdLCJuYW1lcyI6WyJhcHBseUFsbCIsImZucyIsImZuIiwiYXBwbHkiLCJhcmd1bWVudHMiLCJyZWNvZ25pdGlvbkFib3J0YWJsZSIsInJlY29nbml0aW9uIiwiYWJvcnQiLCJDb21wb3NlciIsImNoaWxkcmVuIiwiZXh0cmEiLCJncmFtbWFyIiwibGFuZyIsIm9uRGljdGF0ZSIsIm9uRXJyb3IiLCJvblByb2dyZXNzIiwib25SYXdFdmVudCIsInNwZWVjaEdyYW1tYXJMaXN0Iiwic3BlZWNoUmVjb2duaXRpb24iLCJzdGFydGVkIiwicmVhZHlTdGF0ZSIsInNldFJlYWR5U3RhdGUiLCJlbWl0RGljdGF0ZU9uRW5kUmVmIiwiZXh0cmFSZWYiLCJncmFtbWFyUmVmIiwibGFuZ1JlZiIsIm5vdEFsbG93ZWRSZWYiLCJvbkRpY3RhdGVSZWYiLCJvbkVycm9yUmVmIiwib25Qcm9ncmVzc1JlZiIsIm9uUmF3RXZlbnRSZWYiLCJwcmV2U3BlZWNoUmVjb2duaXRpb24iLCJyZWNvZ25pdGlvblJlZiIsInNwZWVjaEdyYW1tYXJMaXN0UmVmIiwic3BlZWNoUmVjb2duaXRpb25SZWYiLCJjdXJyZW50IiwiaGFuZGxlQXVkaW9FbmQiLCJ0YXJnZXQiLCJoYW5kbGVBdWRpb1N0YXJ0IiwiYWJvcnRhYmxlIiwidHlwZSIsImhhbmRsZUVuZCIsInVuZGVmaW5lZCIsImhhbmRsZUVycm9yIiwiZXZlbnQiLCJlcnJvciIsImhhbmRsZVJhd0V2ZW50IiwiaGFuZGxlUmVzdWx0IiwicmF3UmVzdWx0cyIsInJlc3VsdHMiLCJsZW5ndGgiLCJjYWxsIiwiYWx0cyIsImZpcnN0QWx0IiwiY29uZmlkZW5jZSIsInRyYW5zY3JpcHQiLCJmaXJzdCIsImlzRmluYWwiLCJyZXN1bHQiLCJoYW5kbGVTdGFydCIsIkVycm9yIiwiZ3JhbW1hcnMiLCJhZGRGcm9tU3RyaW5nIiwiaW50ZXJpbVJlc3VsdHMiLCJvbmF1ZGlvZW5kIiwib25hdWRpb3N0YXJ0Iiwib25lbmQiLCJvbmVycm9yIiwib25ub21hdGNoIiwib25yZXN1bHQiLCJvbnNvdW5kZW5kIiwib25zb3VuZHN0YXJ0Iiwib25zcGVlY2hlbmQiLCJvbnNwZWVjaHN0YXJ0Iiwib25zdGFydCIsImtleSIsInZhbHVlIiwic3RhcnQiLCJzdXBwb3J0ZWQiLCJjb250ZXh0IiwiZGVmYXVsdFByb3BzIiwibmF2aWdhdG9yIiwibWVkaWFEZXZpY2VzIiwiZ2V0VXNlck1lZGlhIiwicHJvcFR5cGVzIiwiUHJvcFR5cGVzIiwiYW55Iiwic3RyaW5nIiwiZnVuYyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7O0FBUkE7QUFVQSxTQUFTQSxRQUFULEdBQTBCO0FBQUEsb0NBQUxDLEdBQUs7QUFBTEEsSUFBQUEsR0FBSztBQUFBOztBQUN4QixTQUFPLFlBQVk7QUFBQTtBQUFBOztBQUNqQjtBQUNBLDZCQUFBQSxHQUFHLE1BQUgsQ0FBQUEsR0FBRyxFQUFTLFVBQUFDLEVBQUU7QUFBQSxhQUFJQSxFQUFFLENBQUNDLEtBQUgsQ0FBUyxLQUFULEVBQWVDLFVBQWYsQ0FBSjtBQUFBLEtBQVgsQ0FBSDtBQUNELEdBSEQ7QUFJRDs7QUFFRCxTQUFTQyxvQkFBVCxDQUE4QkMsV0FBOUIsRUFBMkM7QUFDekMsU0FBTyxDQUFDLEVBQUVBLFdBQVcsSUFBSSxPQUFPQSxXQUFXLENBQUNDLEtBQW5CLEtBQTZCLFVBQTlDLENBQVI7QUFDRDs7QUFFRCxJQUFNQyxRQUFRLEdBQUcsU0FBWEEsUUFBVyxPQVlYO0FBQUEsTUFYSkMsUUFXSSxRQVhKQSxRQVdJO0FBQUEsTUFWSkMsS0FVSSxRQVZKQSxLQVVJO0FBQUEsTUFUSkMsT0FTSSxRQVRKQSxPQVNJO0FBQUEsTUFSSkMsSUFRSSxRQVJKQSxJQVFJO0FBQUEsTUFQSkMsU0FPSSxRQVBKQSxTQU9JO0FBQUEsTUFOSkMsT0FNSSxRQU5KQSxPQU1JO0FBQUEsTUFMSkMsVUFLSSxRQUxK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RUFBQUEsaUJBQWlCLEVBQUVvRSxzQkFBVUMsR0FUVjtBQVVuQnBFLEVBQUFBLGlCQUFpQixFQUFFbUUsc0JBQVVDLEdBVlY7QUFXbkJuRSxFQUFBQSxPQUFPLEVBQUVrRSxzQkFBVUM7QUFYQSxDQUFyQjtlQWNlOUUsUSIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCBuby1tYWdpYy1udW1iZXJzOiBbXCJlcnJvclwiLCB7IFwiaWdub3JlXCI6IFswLCAxLCAyLCAzXSB9XSAqL1xuXG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IFJlYWN0LCB7IHVzZUNhbGxiYWNrLCB1c2VFZmZlY3QsIHVzZU1lbW8sIHVzZVJlZiwgdXNlU3RhdGUgfSBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCBDb250ZXh0IGZyb20gJy4vQ29udGV4dCc7XG5pbXBvcnQgdXNlUHJldmlvdXMgZnJvbSAnLi91c2VQcmV2aW91cyc7XG5pbXBvcnQgdXNlUmVmRnJvbSBmcm9tICcuL3VzZVJlZkZyb20nO1xuaW1wb3J0IHZlbmRvclByZWZpeCBmcm9tICcuL3ZlbmRvclByZWZpeCc7XG5cbmZ1bmN0aW9uIGFwcGx5QWxsKC4uLmZucykge1xuICByZXR1cm4gZnVuY3Rpb24gKCkge1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1pbnZhbGlkLXRoaXMsIHByZWZlci1yZXN0LXBhcmFtc1xuICAgIGZucy5mb3JFYWNoKGZuID0+IGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpO1xuICB9O1xufVxuXG5mdW5jdGlvbiByZWNvZ25pdGlvbkFib3J0YWJsZShyZWNvZ25pdGlvbikge1xuICByZXR1cm4gISEocmVjb2duaXRpb24gJiYgdHlwZW9mIHJlY29nbml0aW9uLmFib3J0ID09PSAnZnVuY3Rpb24nKTtcbn1cblxuY29uc3QgQ29tcG9zZXIgPSAoe1xuICBjaGlsZHJlbixcbiAgZXh0cmEsXG4gIGdyYW1tYXIsXG4gIGxhbmcsXG4gIG9uRGljdGF0ZSxcbiAgb25FcnJvcixcbiAgb25Qcm9ncmVzcyxcbiAgb25SYXdFdmVudCxcbiAgc3BlZWNoR3JhbW1hckxpc3QsXG4gIHNwZWVjaFJlY29nbml0aW9uLFxuICBzdGFydGVkXG59KSA9PiB7XG4gIGNvbnN0IFtyZWFkeVN0YXRlLCBzZXRSZWFkeVN0YXRlXSA9IHVzZVN0YXRlKDApO1xuICBjb25zdCBlbWl0RGljdGF0ZU9uRW5kUmVmID0gdXNlUmVmKGZhbHNlKTtcbiAgY29uc3QgZXh0cmFSZWYgPSB1c2VSZWZGcm9tKGV4dHJhKTtcbiAgY29uc3QgZ3JhbW1hclJlZiA9IHVzZVJlZkZyb20oZ3JhbW1hcik7XG4gIGNvbnN0IGxhbmdSZWYgPSB1c2VSZWZGcm9tKGxhbmcpO1xuICBjb25zdCBub3RBbGxvd2VkUmVmID0gdXNlUmVmKGZhbHNlKTtcbiAgY29uc3Qgb25EaWN0YXRlUmVmID0gdXNlUmVmRnJvbShvbkRpY3RhdGUpO1xuICBjb25zdCBvbkVycm9yUmVmID0gdXNlUmVmRnJvbShvbkVycm9yKTtcbiAgY29uc3Qgb25Qcm9ncmVzc1JlZiA9IHVzZVJlZkZyb20ob25Qcm9ncmVzcyk7XG4gIGNvbnN0IG9uUmF3RXZlbnRSZWYgPSB1c2VSZWZGcm9tKG9uUmF3RXZlbnQpO1xuICBjb25zdCBwcmV2U3BlZWNoUmVjb2duaXRpb24gPSB1c2VQcmV2aW91cyhzcGVlY2hSZWNvZ25pdGlvbik7XG4gIGNvbnN0IHJlY29nbml0aW9uUmVmID0gdXNlUmVmKCk7XG4gIGNvbnN0IHNwZWVjaEdyYW1tYXJMaXN0UmVmID0gdXNlUmVmRnJvbShzcGVlY2hHcmFtbWFyTGlzdCk7XG4gIGNvbnN0IHNwZWVjaFJlY29nbml0aW9uUmVmID0gdXNlUmVmRnJvbShzcGVlY2hSZWNvZ25pdGlvbik7XG5cbiAgLy8gSWYgXCJzcGVlY2hSZWNvZ25pdGlvblwiIHBvbnlmaWxsIGNoYW5nZWQsIHJlc2V0IHRoZSBcIm5vdEFsbG93ZWRcIiBmbGFnLlxuICBpZiAocHJldlNwZWVjaFJlY29nbml0aW9uICE9PSBzcGVlY2hSZWNvZ25pdGlvbikge1xuICAgIG5vdEFsbG93ZWRSZWYuY3VycmVudCA9IGZhbHNlO1xuICB9XG5cbiAgY29uc3QgaGFuZGxlQXVkaW9FbmQgPSB1c2VDYWxsYmFjayhcbiAgICAoeyB0YXJnZXQgfSkgPT4gdGFyZ2V0ID09PSByZWNvZ25pdGlvblJlZi5jdXJyZW50ICYmIHNldFJlYWR5U3RhdGUoMyksXG4gICAgW3JlY29nbml0aW9uUmVmLCBzZXRSZWFkeVN0YXRlXVxuICApO1xuXG4gIGNvbnN0IGhhbmRsZUF1ZGlvU3RhcnQgPSB1c2VDYWxsYmFjayhcbiAgICAoeyB0YXJnZXQgfSkgPT4ge1xuICAgICAgaWYgKHRhcmdldCAhPT0gcmVjb2duaXRpb25SZWYuY3VycmVudCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIHNldFJlYWR5U3RhdGUoMik7XG5cbiAgICAgIC8vIFdlYiBTcGVlY2ggQVBJIGRvZXMgbm90IGVtaXQgXCJyZXN1bHRcIiB3aGVuIG5vdGhpbmcgaXMgaGVhcmQsIGFuZCBDaHJvbWUgZG9lcyBub3QgZW1pdCBcIm5vbWF0Y2hcIiBldmVudC5cbiAgICAgIC8vIEJlY2F1c2Ugd2UgZW1pdHRlZCBvblByb2dyZXNzLCB3ZSBzaG91bGQgZW1pdCBcImRpY3RhdGVcIiBpZiBub3QgZXJyb3IsIHNvIHRoZXkgd29ya3MgaW4gcGFpci5cbiAgICAgIGVtaXREaWN0YXRlT25FbmRSZWYuY3VycmVudCA9IHRydWU7XG4gICAgICBvblByb2dyZXNzUmVmLmN1cnJlbnQgJiYgb25Qcm9ncmVzc1JlZi5jdXJyZW50KHsgYWJvcnRhYmxlOiByZWNvZ25pdGlvbkFib3J0YWJsZSh0YXJnZXQpLCB0eXBlOiAncHJvZ3Jlc3MnIH0pO1xuICAgIH0sXG4gICAgW2VtaXREaWN0YXRlT25FbmRSZWYsIG9uUHJvZ3Jlc3NSZWYsIHJlY29nbml0aW9uUmVmLCBzZXRSZWFkeVN0YXRlXVxuICApO1xuXG4gIGNvbnN0IGhhbmRsZUVuZCA9IHVzZUNhbGxiYWNrKFxuICAgICh7IHRhcmdldCB9KSA9PiB7XG4gICAgICBpZiAodGFyZ2V0ICE9PSByZWNvZ25pdGlvblJlZi5jdXJyZW50KSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgcmVjb2duaXRpb25SZWYuY3VycmVudCA9IHVuZGVmaW5lZDtcbiAgICAgIHNldFJlYWR5U3RhdGUoMCk7XG5cbiAgICAgIGlmIChlbWl0RGljdGF0ZU9uRW5kUmVmLmN1cnJlbnQpIHtcbiAgICAgICAgb25EaWN0YXRlUmVmLmN1cnJlbnQgJiYgb25EaWN0YXRlUmVmLmN1cnJlbnQoeyB0eXBlOiAnZGljdGF0ZScgfSk7XG4gICAgICAgIGVtaXREaWN0YXRlT25FbmRSZWYuY3VycmVudCA9IGZhbHNlO1xuICAgICAgfVxuICAgIH0sXG4gICAgW2VtaXREaWN0YXRlT25FbmRSZWYsIG9uRGljdGF0ZVJlZiwgcmVjb2duaXRpb25SZWYsIHNldFJlYWR5U3RhdGVdXG4gICk7XG5cbiAgY29uc3QgaGFuZGxlRXJyb3IgPSB1c2VDYWxsYmFjayhcbiAgICBldmVudCA9PiB7XG4gICAgICBpZiAoZXZlbnQudGFyZ2V0ICE9PSByZWNvZ25pdGlvblJlZi5jdXJyZW50KSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gRXJyb3Igb3V0LCBubyBuZWVkIHRvIGVtaXQgXCJkaWN0YXRlXCJcbiAgICAgIGVtaXREaWN0YXRlT25FbmRSZWYuY3VycmVudCA9IGZhbHNlO1xuICAgICAgcmVjb2duaXRpb25SZWYuY3VycmVudCA9IHVuZGVmaW5lZDtcblxuICAgICAgaWYgKGV2ZW50LmVycm9yID09PSAnbm90LWFsbG93ZWQnKSB7XG4gICAgICAgIG5vdEFsbG93ZWRSZWYuY3VycmVudCA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIHNldFJlYWR5U3RhdGUoMCk7XG5cbiAgICAgIG9uRXJyb3JSZWYuY3VycmVudCAmJiBvbkVycm9yUmVmLmN1cnJlbnQoZXZlbnQpO1xuICAgIH0sXG4gICAgW2VtaXREaWN0YXRlT25FbmRSZWYsIG9uRXJyb3JSZWYsIG5vdEFsbG93ZWRSZWYsIHJlY29nbml0aW9uUmVmLCBzZXRSZWFkeVN0YXRlXVxuICApO1xuXG4gIGNvbnN0IGhhbmRsZVJhd0V2ZW50ID0gdXNlQ2FsbGJhY2soXG4gICAgZXZlbnQgPT4ge1xuICAgICAgaWYgKGV2ZW50LnRhcmdldCAhPT0gcmVjb2duaXRpb25SZWYuY3VycmVudCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIG9uUmF3RXZlbnRSZWYuY3VycmVudCAmJiBvblJhd0V2ZW50UmVmLmN1cnJlbnQoZXZlbnQpO1xuICAgIH0sXG4gICAgW29uUmF3RXZlbnRSZWYsIHJlY29nbml0aW9uUmVmXVxuICApO1xuXG4gIGNvbnN0IGhhbmRsZVJlc3VsdCA9IHVzZUNhbGxiYWNrKFxuICAgICh7IHJlc3VsdHM6IHJhd1Jlc3VsdHMsIHRhcmdldCB9KSA9PiB7XG4gICAgICBpZiAodGFyZ2V0ICE9PSByZWNvZ25pdGlvblJlZi5jdXJyZW50KSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKHJhd1Jlc3VsdHMubGVuZ3RoKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdHMgPSBbXS5tYXAuY2FsbChyYXdSZXN1bHRzLCBhbHRzID0+IHtcbiAgICAgICAgICAvLyBEZXN0cnVjdHVyaW5nIGJyZWFrcyBBbmd1bGFyIGR1ZSB0byBhIGJ1ZyBpbiBab25lLmpzLlxuICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBwcmVmZXItZGVzdHJ1Y3R1cmluZ1xuICAgICAgICAgIGNvbnN0IGZpcnN0QWx0ID0gYWx0c1swXTtcblxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjb25maWRlbmNlOiBmaXJzdEFsdC5jb25maWRlbmNlLFxuICAgICAgICAgICAgdHJhbnNjcmlwdDogZmlyc3RBbHQudHJhbnNjcmlwdFxuICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIERlc3RydWN0dXJpbmcgYnJlYWtzIEFuZ3VsYXIgZHVlIHRvIGEgYnVnIGluIFpvbmUuanMuXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBwcmVmZXItZGVzdHJ1Y3R1cmluZ1xuICAgICAgICBjb25zdCBmaXJzdCA9IHJhd1Jlc3VsdHNbMF07XG5cbiAgICAgICAgaWYgKGZpcnN0LmlzRmluYWwpIHtcbiAgICAgICAgICAvLyBBZnRlciBcIm9uRGljdGF0ZVwiIGNhbGxiYWNrLCB0aGUgY2FsbGVyIHNob3VsZCBiZSBhYmxlIHRvIHNldCBcInN0YXJ0ZWRcIiB0byBmYWxzZSBvbiBhbiB1bmFib3J0YWJsZSByZWNvZ25pdGlvbi5cbiAgICAgICAgICAvLyBUT0RPOiBBZGQgdGVzdCBmb3IgZm9ydGlmaWNhdGlvbi5cbiAgICAgICAgICByZWNvZ25pdGlvblJlZi5jdXJyZW50ID0gdW5kZWZpbmVkO1xuICAgICAgICAgIHNldFJlYWR5U3RhdGUoMCk7XG5cbiAgICAgICAgICBvbkRpY3RhdGVSZWYuY3VycmVudCAmJiBvbkRpY3RhdGVSZWYuY3VycmVudCh7IHJlc3VsdDogcmVzdWx0c1swXSwgdHlwZTogJ2RpY3RhdGUnIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG9uUHJvZ3Jlc3NSZWYuY3VycmVudCAmJlxuICAgICAgICAgICAgb25Qcm9ncmVzc1JlZi5jdXJyZW50KHsgYWJvcnRhYmxlOiByZWNvZ25pdGlvbkFib3J0YWJsZSh0YXJnZXQpLCByZXN1bHRzLCB0eXBlOiAncHJvZ3Jlc3MnIH0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSxcbiAgICBbb25EaWN0YXRlUmVmLCBvblByb2dyZXNzUmVmLCByZWNvZ25pdGlvblJlZiwgc2V0UmVhZHlTdGF0ZV1cbiAgKTtcblxuICBjb25zdCBoYW5kbGVTdGFydCA9IHVzZUNhbGxiYWNrKFxuICAgICh7IHRhcmdldCB9KSA9PiB0YXJnZXQgPT09IHJlY29nbml0aW9uUmVmLmN1cnJlbnQgJiYgc2V0UmVhZHlTdGF0ZSgxKSxcbiAgICBbcmVjb2duaXRpb25SZWYsIHNldFJlYWR5U3RhdGVdXG4gICk7XG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAoc3RhcnRlZCkge1xuICAgICAgaWYgKCFzcGVlY2hSZWNvZ25pdGlvblJlZi5jdXJyZW50IHx8IG5vdEFsbG93ZWRSZWYuY3VycmVudCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NwZWVjaCByZWNvZ25pdGlvbiBpcyBub3Qgc3VwcG9ydGVkJyk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGdyYW1tYXJzID0gc3BlZWNoR3JhbW1hckxpc3RSZWYuY3VycmVudCAmJiBncmFtbWFyUmVmLmN1cnJlbnQgJiYgbmV3IHNwZWVjaEdyYW1tYXJMaXN0UmVmLmN1cnJlbnQoKTtcbiAgICAgIGNvbnN0IHJlY29nbml0aW9uID0gKHJlY29nbml0aW9uUmVmLmN1cnJlbnQgPSBuZXcgc3BlZWNoUmVjb2duaXRpb25SZWYuY3VycmVudCgpKTtcblxuICAgICAgaWYgKGdyYW1tYXJzKSB7XG4gICAgICAgIGdyYW1tYXJzLmFkZEZyb21TdHJpbmcoZ3JhbW1hclJlZi5jdXJyZW50LCAxKTtcblxuICAgICAgICByZWNvZ25pdGlvbi5ncmFtbWFycyA9IGdyYW1tYXJzO1xuICAgICAgfVxuXG4gICAgICByZWNvZ25pdGlvbi5sYW5nID0gbGFuZ1JlZi5jdXJyZW50O1xuICAgICAgcmVjb2duaXRpb24uaW50ZXJpbVJlc3VsdHMgPSB0cnVlO1xuICAgICAgcmVjb2duaXRpb24ub25hdWRpb2VuZCA9IGFwcGx5QWxsKGhhbmRsZUF1ZGlvRW5kLCBoYW5kbGVSYXdFdmVudCk7XG4gICAgICByZWNvZ25pdGlvbi5vbmF1ZGlvc3RhcnQgPSBhcHBseUFsbChoYW5kbGVBdWRpb1N0YXJ0LCBoYW5kbGVSYXdFdmVudCk7XG4gICAgICByZWNvZ25pdGlvbi5vbmVuZCA9IGFwcGx5QWxsKGhhbmRsZUVuZCwgaGFuZGxlUmF3RXZlbnQpO1xuICAgICAgcmVjb2duaXRpb24ub25lcnJvciA9IGFwcGx5QWxsKGhhbmRsZUVycm9yLCBoYW5kbGVSYXdFdmVudCk7XG4gICAgICByZWNvZ25pdGlvbi5vbm5vbWF0Y2ggPSBoYW5kbGVSYXdFdmVudDtcbiAgICAgIHJlY29nbml0aW9uLm9ucmVzdWx0ID0gYXBwbHlBbGwoaGFuZGxlUmVzdWx0LCBoYW5kbGVSYXdFdmVudCk7XG4gICAgICByZWNvZ25pdGlvbi5vbnNvdW5kZW5kID0gaGFuZGxlUmF3RXZlbnQ7XG4gICAgICByZWNvZ25pdGlvbi5vbnNvdW5kc3RhcnQgPSBoYW5kbGVSYXdFdmVudDtcbiAgICAgIHJlY29nbml0aW9uLm9uc3BlZWNoZW5kID0gaGFuZGxlUmF3RXZlbnQ7XG4gICAgICByZWNvZ25pdGlvbi5vbnNwZWVjaHN0YXJ0ID0gaGFuZGxlUmF3RXZlbnQ7XG4gICAgICByZWNvZ25pdGlvbi5vbnN0YXJ0ID0gYXBwbHlBbGwoaGFuZGxlU3RhcnQsIGhhbmRsZVJhd0V2ZW50KTtcblxuICAgICAgY29uc3QgeyBjdXJyZW50OiBleHRyYSB9ID0gZXh0cmFSZWY7XG5cbiAgICAgIGV4dHJhICYmXG4gICAgICAgIE9iamVjdC5lbnRyaWVzKGV4dHJhKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgICAgICBpZiAoa2V5ICE9PSAnY29uc3RydWN0b3InICYmIGtleSAhPT0gJ3Byb3RvdHlwZScgJiYga2V5ICE9PSAnX19wcm90b19fJykge1xuICAgICAgICAgICAgcmVjb2duaXRpb25ba2V5XSA9IHZhbHVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgIHJlY29nbml0aW9uLnN0YXJ0KCk7XG4gICAgfVxuXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNvbnN0IHsgY3VycmVudDogcmVjb2duaXRpb24gfSA9IHJlY29nbml0aW9uUmVmO1xuXG4gICAgICBpZiAocmVjb2duaXRpb24pIHtcbiAgICAgICAgaWYgKHJlY29nbml0aW9uQWJvcnRhYmxlKHJlY29nbml0aW9uKSkge1xuICAgICAgICAgIHJlY29nbml0aW9uLmFib3J0KCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gc3RvcCByZWNvZ25pdGlvbiB3aGlsZSB0aGUgY3VycmVudCBvbmUgaXMgb25nb2luZyBhbmQgaXMgbm90IGFib3J0YWJsZS4nKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH07XG4gIH0sIFtcbiAgICBleHRyYVJlZixcbiAgICBncmFtbWFyUmVmLFxuICAgIGhhbmRsZUF1ZGlvRW5kLFxuICAgIGhhbmRsZUF1ZGlvU3RhcnQsXG4gICAgaGFuZGxlRW5kLFxuICAgIGhhbmRsZUVycm9yLFxuICAgIGhhbmRsZVJhd0V2ZW50LFxuICAgIGhhbmRsZVJlc3VsdCxcbiAgICBoYW5kbGVTdGFydCxcbiAgICBsYW5nUmVmLFxuICAgIG5vdEFsbG93ZWRSZWYsXG4gICAgcmVjb2duaXRpb25SZWYsXG4gICAgc3BlZWNoR3JhbW1hckxpc3RSZWYsXG4gICAgc3BlZWNoUmVjb2duaXRpb25SZWYsXG4gICAgc3RhcnRlZFxuICBdKTtcblxuICBjb25zdCBhYm9ydGFibGUgPSByZWNvZ25pdGlvbkFib3J0YWJsZShyZWNvZ25pdGlvblJlZi5jdXJyZW50KSAmJiByZWFkeVN0YXRlID09PSAyO1xuICBjb25zdCBzdXBwb3J0ZWQgPSAhIXNwZWVjaFJlY29nbml0aW9uICYmICFub3RBbGxvd2VkUmVmLmN1cnJlbnQ7XG5cbiAgY29uc3QgY29udGV4dCA9IHVzZU1lbW8oXG4gICAgKCkgPT4gKHtcbiAgICAgIGFib3J0YWJsZSxcbiAgICAgIHJlYWR5U3RhdGUsXG4gICAgICBzdXBwb3J0ZWRcbiAgICB9KSxcbiAgICBbYWJvcnRhYmxlLCByZWFkeVN0YXRlLCBzdXBwb3J0ZWRdXG4gICk7XG5cbiAgcmV0dXJuIChcbiAgICA8Q29udGV4dC5Qcm92aWRlciB2YWx1ZT17Y29udGV4dH0+XG4gICAgICA8Q29udGV4dC5Db25zdW1lcj57Y29udGV4dCA9PiAodHlwZW9mIGNoaWxkcmVuID09PSAnZnVuY3Rpb24nID8gY2hpbGRyZW4oY29udGV4dCkgOiBjaGlsZHJlbil9PC9Db250ZXh0LkNvbnN1bWVyPlxuICAgIDwvQ29udGV4dC5Qcm92aWRlcj5cbiAgKTtcbn07XG5cbkNvbXBvc2VyLmRlZmF1bHRQcm9wcyA9IHtcbiAgY2hpbGRyZW46IHVuZGVmaW5lZCxcbiAgZXh0cmE6IHVuZGVmaW5lZCxcbiAgZ3JhbW1hcjogdW5kZWZpbmVkLFxuICBsYW5nOiB1bmRlZmluZWQsXG4gIG9uRGljdGF0ZTogdW5kZWZpbmVkLFxuICBvbkVycm9yOiB1bmRlZmluZWQsXG4gIG9uUHJvZ3Jlc3M6IHVuZGVmaW5lZCxcbiAgb25SYXdFdmVudDogdW5kZWZpbmVkLFxuICBzcGVlY2hHcmFtbWFyTGlzdDogbmF2aWdhdG9yLm1lZGlhRGV2aWNlcyAmJiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSAmJiB2ZW5kb3JQcmVmaXgoJ1NwZWVjaEdyYW1tYXJMaXN0JyksXG4gIHNwZWVjaFJlY29nbml0aW9uOiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzICYmIG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhICYmIHZlbmRvclByZWZpeCgnU3BlZWNoUmVjb2duaXRpb24nKSxcbiAgc3RhcnRlZDogdW5kZWZpbmVkXG59O1xuXG5Db21wb3Nlci5wcm9wVHlwZXMgPSB7XG4gIGNoaWxkcmVuOiBQcm9wVHlwZXMuYW55LFxuICBleHRyYTogUHJvcFR5cGVzLmFueSxcbiAgZ3JhbW1hcjogUHJvcFR5cGVzLnN0cmluZyxcbiAgbGFuZzogUHJvcFR5cGVzLnN0cmluZyxcbiAgb25EaWN0YXRlOiBQcm9wVHlwZXMuZnVuYyxcbiAgb25FcnJvcjogUHJvcFR5cGVzLmZ1bmMsXG4gIG9uUHJvZ3Jlc3M6IFByb3BUeXBlcy5mdW5jLFxuICBvblJhd0V2ZW50OiBQcm9wVHlwZXMuZnVuYyxcbiAgc3BlZWNoR3JhbW1hckxpc3Q6IFByb3BUeXBlcy5hbnksXG4gIHNwZWVjaFJlY29nbml0aW9uOiBQcm9wVHlwZXMuYW55LFxuICBzdGFydGVkOiBQcm9wVHlwZXMuYW55XG59O1xuXG5leHBvcnQgZGVmYXVsdCBDb21wb3NlcjtcbiJdfQ==