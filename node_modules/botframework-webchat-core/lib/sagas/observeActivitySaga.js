"use strict";

var _regeneratorRuntime2 = require("@babel/runtime/regenerator");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = observeActivitySaga;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _effects = require("redux-saga/effects");

var _simpleUpdateIn = _interopRequireDefault(require("simple-update-in"));

var _observeEach = _interopRequireDefault(require("./effects/observeEach"));

var _queueIncomingActivity = _interopRequireDefault(require("../actions/queueIncomingActivity"));

var _whileConnected = _interopRequireDefault(require("./effects/whileConnected"));

var _marked = /*#__PURE__*/_regeneratorRuntime2.mark(observeActivity),
    _marked2 = /*#__PURE__*/_regeneratorRuntime2.mark(observeActivitySaga);

var PASSTHRU_FN = function PASSTHRU_FN(value) {
  return value;
};

function patchActivityWithFromRole(activity, userID) {
  // Some activities, such as "ConversationUpdate", does not have "from" defined.
  // And although "role" is defined in Direct Line spec, it was not sent over the wire.
  // We normalize the activity here to simplify null-check and logic later.
  // Patch activity.from.role to make sure its either "bot", "user", or "channel"
  if (!activity.from) {
    activity = (0, _simpleUpdateIn["default"])(activity, ['from', 'role'], function () {
      return 'channel';
    });
  } else if (!activity.from.role) {
    if (activity.from.id === userID) {
      activity = (0, _simpleUpdateIn["default"])(activity, ['from', 'role'], function () {
        return 'user';
      });
    } else if (activity.from.id) {
      activity = (0, _simpleUpdateIn["default"])(activity, ['from', 'role'], function () {
        return 'bot';
      });
    } else {
      activity = (0, _simpleUpdateIn["default"])(activity, ['from', 'role'], function () {
        return 'channel';
      });
    }
  }

  return activity;
}

function patchNullAsUndefined(activity) {
  // These fields are known used in Web Chat and in any cases, they should not be null, but undefined.
  // The only field omitted is "value", as it could be null purposefully.
  return ['attachmentLayout', 'attachments', 'channelData', 'conversation', 'entities', 'from', 'inputHint', 'locale', 'name', 'recipient', 'speak', 'suggestedActions', 'text', 'textFormat', 'timestamp', 'type'].reduce(function (activity, name) {
    var value = activity[name];
    return (0, _simpleUpdateIn["default"])(activity, [name], typeof value === 'undefined' || value === null ? undefined : PASSTHRU_FN);
  }, activity);
} // Patching the `from.name` to be a human readable name.
// We use the `from.name` for typing indicator, such that it read "John is typing...".


function patchFromName(activity) {
  return (0, _simpleUpdateIn["default"])(activity, ['from', 'name'], function (name) {
    var channelId = activity.channelId,
        _activity$from = activity.from,
        from = _activity$from === void 0 ? {} : _activity$from;

    if ((channelId === 'directline' || channelId === 'webchat') && from.id === from.name && from.role === 'bot') {
      return 'Bot';
    }

    return name;
  });
}

function observeActivity(_ref) {
  var directLine, userID;
  return _regenerator["default"].wrap(function observeActivity$(_context2) {
    while (1) {
      switch (_context2.prev = _context2.next) {
        case 0:
          directLine = _ref.directLine, userID = _ref.userID;
          _context2.next = 3;
          return (0, _observeEach["default"])(directLine.activity$, /*#__PURE__*/_regenerator["default"].mark(function observeActivity(activity) {
            return _regenerator["default"].wrap(function observeActivity$(_context) {
              while (1) {
                switch (_context.prev = _context.next) {
                  case 0:
                    // TODO: [P2] #3953 Move the patching logic to a DirectLineJS wrapper, instead of too close to inners of Web Chat.
                    activity = patchNullAsUndefined(activity);
                    activity = patchActivityWithFromRole(activity, userID);
                    activity = patchFromName(activity);
                    _context.next = 5;
                    return (0, _effects.put)((0, _queueIncomingActivity["default"])(activity));

                  case 5:
                  case "end":
                    return _context.stop();
                }
              }
            }, observeActivity);
          }));

        case 3:
        case "end":
          return _context2.stop();
      }
    }
  }, _marked);
}

function observeActivitySaga() {
  return _regenerator["default"].wrap(function observeActivitySaga$(_context3) {
    while (1) {
      switch (_context3.prev = _context3.next) {
        case 0:
          _context3.next = 2;
          return (0, _whileConnected["default"])(observeActivity);

        case 2:
        case "end":
          return _context3.stop();
      }
    }
  }, _marked2);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJvYnNlcnZlQWN0aXZpdHkiLCJvYnNlcnZlQWN0aXZpdHlTYWdhIiwiUEFTU1RIUlVfRk4iLCJ2YWx1ZSIsInBhdGNoQWN0aXZpdHlXaXRoRnJvbVJvbGUiLCJhY3Rpdml0eSIsInVzZXJJRCIsImZyb20iLCJ1cGRhdGVJbiIsInJvbGUiLCJpZCIsInBhdGNoTnVsbEFzVW5kZWZpbmVkIiwicmVkdWNlIiwibmFtZSIsInVuZGVmaW5lZCIsInBhdGNoRnJvbU5hbWUiLCJjaGFubmVsSWQiLCJkaXJlY3RMaW5lIiwib2JzZXJ2ZUVhY2giLCJhY3Rpdml0eSQiLCJwdXQiLCJxdWV1ZUluY29taW5nQWN0aXZpdHkiLCJ3aGlsZUNvbm5lY3RlZCJdLCJzb3VyY2VSb290IjoiY29yZTovLy8iLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zYWdhcy9vYnNlcnZlQWN0aXZpdHlTYWdhLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHB1dCB9IGZyb20gJ3JlZHV4LXNhZ2EvZWZmZWN0cyc7XG5pbXBvcnQgdXBkYXRlSW4gZnJvbSAnc2ltcGxlLXVwZGF0ZS1pbic7XG5cbmltcG9ydCBvYnNlcnZlRWFjaCBmcm9tICcuL2VmZmVjdHMvb2JzZXJ2ZUVhY2gnO1xuaW1wb3J0IHF1ZXVlSW5jb21pbmdBY3Rpdml0eSBmcm9tICcuLi9hY3Rpb25zL3F1ZXVlSW5jb21pbmdBY3Rpdml0eSc7XG5pbXBvcnQgd2hpbGVDb25uZWN0ZWQgZnJvbSAnLi9lZmZlY3RzL3doaWxlQ29ubmVjdGVkJztcbmltcG9ydCB0eXBlIHsgRGlyZWN0TGluZUFjdGl2aXR5IH0gZnJvbSAnLi4vdHlwZXMvZXh0ZXJuYWwvRGlyZWN0TGluZUFjdGl2aXR5JztcbmltcG9ydCB0eXBlIHsgRGlyZWN0TGluZUpTQm90Q29ubmVjdGlvbiB9IGZyb20gJy4uL3R5cGVzL2V4dGVybmFsL0RpcmVjdExpbmVKU0JvdENvbm5lY3Rpb24nO1xuaW1wb3J0IHR5cGUgeyBXZWJDaGF0QWN0aXZpdHkgfSBmcm9tICcuLi90eXBlcy9XZWJDaGF0QWN0aXZpdHknO1xuXG5jb25zdCBQQVNTVEhSVV9GTiA9ICh2YWx1ZTogdW5rbm93bikgPT4gdmFsdWU7XG5cbmZ1bmN0aW9uIHBhdGNoQWN0aXZpdHlXaXRoRnJvbVJvbGUoYWN0aXZpdHk6IERpcmVjdExpbmVBY3Rpdml0eSwgdXNlcklEPzogc3RyaW5nKTogRGlyZWN0TGluZUFjdGl2aXR5IHtcbiAgLy8gU29tZSBhY3Rpdml0aWVzLCBzdWNoIGFzIFwiQ29udmVyc2F0aW9uVXBkYXRlXCIsIGRvZXMgbm90IGhhdmUgXCJmcm9tXCIgZGVmaW5lZC5cbiAgLy8gQW5kIGFsdGhvdWdoIFwicm9sZVwiIGlzIGRlZmluZWQgaW4gRGlyZWN0IExpbmUgc3BlYywgaXQgd2FzIG5vdCBzZW50IG92ZXIgdGhlIHdpcmUuXG4gIC8vIFdlIG5vcm1hbGl6ZSB0aGUgYWN0aXZpdHkgaGVyZSB0byBzaW1wbGlmeSBudWxsLWNoZWNrIGFuZCBsb2dpYyBsYXRlci5cblxuICAvLyBQYXRjaCBhY3Rpdml0eS5mcm9tLnJvbGUgdG8gbWFrZSBzdXJlIGl0cyBlaXRoZXIgXCJib3RcIiwgXCJ1c2VyXCIsIG9yIFwiY2hhbm5lbFwiXG4gIGlmICghYWN0aXZpdHkuZnJvbSkge1xuICAgIGFjdGl2aXR5ID0gdXBkYXRlSW4oYWN0aXZpdHksIFsnZnJvbScsICdyb2xlJ10sICgpID0+ICdjaGFubmVsJyk7XG4gIH0gZWxzZSBpZiAoIWFjdGl2aXR5LmZyb20ucm9sZSkge1xuICAgIGlmIChhY3Rpdml0eS5mcm9tLmlkID09PSB1c2VySUQpIHtcbiAgICAgIGFjdGl2aXR5ID0gdXBkYXRlSW4oYWN0aXZpdHksIFsnZnJvbScsICdyb2xlJ10sICgpID0+ICd1c2VyJyk7XG4gICAgfSBlbHNlIGlmIChhY3Rpdml0eS5mcm9tLmlkKSB7XG4gICAgICBhY3Rpdml0eSA9IHVwZGF0ZUluKGFjdGl2aXR5LCBbJ2Zyb20nLCAncm9sZSddLCAoKSA9PiAnYm90Jyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGFjdGl2aXR5ID0gdXBkYXRlSW4oYWN0aXZpdHksIFsnZnJvbScsICdyb2xlJ10sICgpID0+ICdjaGFubmVsJyk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGFjdGl2aXR5O1xufVxuXG5mdW5jdGlvbiBwYXRjaE51bGxBc1VuZGVmaW5lZChhY3Rpdml0eTogRGlyZWN0TGluZUFjdGl2aXR5KTogRGlyZWN0TGluZUFjdGl2aXR5IHtcbiAgLy8gVGhlc2UgZmllbGRzIGFyZSBrbm93biB1c2VkIGluIFdlYiBDaGF0IGFuZCBpbiBhbnkgY2FzZXMsIHRoZXkgc2hvdWxkIG5vdCBiZSBudWxsLCBidXQgdW5kZWZpbmVkLlxuICAvLyBUaGUgb25seSBmaWVsZCBvbWl0dGVkIGlzIFwidmFsdWVcIiwgYXMgaXQgY291bGQgYmUgbnVsbCBwdXJwb3NlZnVsbHkuXG5cbiAgcmV0dXJuIFtcbiAgICAnYXR0YWNobWVudExheW91dCcsXG4gICAgJ2F0dGFjaG1lbnRzJyxcbiAgICAnY2hhbm5lbERhdGEnLFxuICAgICdjb252ZXJzYXRpb24nLFxuICAgICdlbnRpdGllcycsXG4gICAgJ2Zyb20nLFxuICAgICdpbnB1dEhpbnQnLFxuICAgICdsb2NhbGUnLFxuICAgICduYW1lJyxcbiAgICAncmVjaXBpZW50JyxcbiAgICAnc3BlYWsnLFxuICAgICdzdWdnZXN0ZWRBY3Rpb25zJyxcbiAgICAndGV4dCcsXG4gICAgJ3RleHRGb3JtYXQnLFxuICAgICd0aW1lc3RhbXAnLFxuICAgICd0eXBlJ1xuICBdLnJlZHVjZSgoYWN0aXZpdHksIG5hbWUpID0+IHtcbiAgICBjb25zdCB7IFtuYW1lXTogdmFsdWUgfSA9IGFjdGl2aXR5O1xuXG4gICAgcmV0dXJuIHVwZGF0ZUluKGFjdGl2aXR5LCBbbmFtZV0sIHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgdmFsdWUgPT09IG51bGwgPyB1bmRlZmluZWQgOiBQQVNTVEhSVV9GTik7XG4gIH0sIGFjdGl2aXR5KTtcbn1cblxuLy8gUGF0Y2hpbmcgdGhlIGBmcm9tLm5hbWVgIHRvIGJlIGEgaHVtYW4gcmVhZGFibGUgbmFtZS5cbi8vIFdlIHVzZSB0aGUgYGZyb20ubmFtZWAgZm9yIHR5cGluZyBpbmRpY2F0b3IsIHN1Y2ggdGhhdCBpdCByZWFkIFwiSm9obiBpcyB0eXBpbmcuLi5cIi5cbmZ1bmN0aW9uIHBhdGNoRnJvbU5hbWUoYWN0aXZpdHk6IERpcmVjdExpbmVBY3Rpdml0eSkge1xuICByZXR1cm4gdXBkYXRlSW4oYWN0aXZpdHksIFsnZnJvbScsICduYW1lJ10sIChuYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQpOiBzdHJpbmcgPT4ge1xuICAgIGNvbnN0IHsgY2hhbm5lbElkLCBmcm9tID0ge30gfSA9IGFjdGl2aXR5O1xuXG4gICAgaWYgKChjaGFubmVsSWQgPT09ICdkaXJlY3RsaW5lJyB8fCBjaGFubmVsSWQgPT09ICd3ZWJjaGF0JykgJiYgZnJvbS5pZCA9PT0gZnJvbS5uYW1lICYmIGZyb20ucm9sZSA9PT0gJ2JvdCcpIHtcbiAgICAgIHJldHVybiAnQm90JztcbiAgICB9XG5cbiAgICByZXR1cm4gbmFtZTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uKiBvYnNlcnZlQWN0aXZpdHkoeyBkaXJlY3RMaW5lLCB1c2VySUQgfTogeyBkaXJlY3RMaW5lOiBEaXJlY3RMaW5lSlNCb3RDb25uZWN0aW9uOyB1c2VySUQ/OiBzdHJpbmcgfSkge1xuICB5aWVsZCBvYnNlcnZlRWFjaChkaXJlY3RMaW5lLmFjdGl2aXR5JCwgZnVuY3Rpb24qIG9ic2VydmVBY3Rpdml0eShhY3Rpdml0eTogRGlyZWN0TGluZUFjdGl2aXR5KSB7XG4gICAgLy8gVE9ETzogW1AyXSAjMzk1MyBNb3ZlIHRoZSBwYXRjaGluZyBsb2dpYyB0byBhIERpcmVjdExpbmVKUyB3cmFwcGVyLCBpbnN0ZWFkIG9mIHRvbyBjbG9zZSB0byBpbm5lcnMgb2YgV2ViIENoYXQuXG4gICAgYWN0aXZpdHkgPSBwYXRjaE51bGxBc1VuZGVmaW5lZChhY3Rpdml0eSk7XG4gICAgYWN0aXZpdHkgPSBwYXRjaEFjdGl2aXR5V2l0aEZyb21Sb2xlKGFjdGl2aXR5LCB1c2VySUQpO1xuICAgIGFjdGl2aXR5ID0gcGF0Y2hGcm9tTmFtZShhY3Rpdml0eSk7XG5cbiAgICB5aWVsZCBwdXQocXVldWVJbmNvbWluZ0FjdGl2aXR5KGFjdGl2aXR5IGFzIFdlYkNoYXRBY3Rpdml0eSkpO1xuICB9KTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24qIG9ic2VydmVBY3Rpdml0eVNhZ2EoKSB7XG4gIHlpZWxkIHdoaWxlQ29ubmVjdGVkKG9ic2VydmVBY3Rpdml0eSk7XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7cURBc0VVQSxlO3NEQVdlQyxtQjs7QUE1RXpCLElBQU1DLFdBQVcsR0FBRyxTQUFkQSxXQUFjLENBQUNDLEtBQUQ7RUFBQSxPQUFvQkEsS0FBcEI7QUFBQSxDQUFwQjs7QUFFQSxTQUFTQyx5QkFBVCxDQUFtQ0MsUUFBbkMsRUFBaUVDLE1BQWpFLEVBQXNHO0VBQ3BHO0VBQ0E7RUFDQTtFQUVBO0VBQ0EsSUFBSSxDQUFDRCxRQUFRLENBQUNFLElBQWQsRUFBb0I7SUFDbEJGLFFBQVEsR0FBRyxJQUFBRywwQkFBQSxFQUFTSCxRQUFULEVBQW1CLENBQUMsTUFBRCxFQUFTLE1BQVQsQ0FBbkIsRUFBcUM7TUFBQSxPQUFNLFNBQU47SUFBQSxDQUFyQyxDQUFYO0VBQ0QsQ0FGRCxNQUVPLElBQUksQ0FBQ0EsUUFBUSxDQUFDRSxJQUFULENBQWNFLElBQW5CLEVBQXlCO0lBQzlCLElBQUlKLFFBQVEsQ0FBQ0UsSUFBVCxDQUFjRyxFQUFkLEtBQXFCSixNQUF6QixFQUFpQztNQUMvQkQsUUFBUSxHQUFHLElBQUFHLDBCQUFBLEVBQVNILFFBQVQsRUFBbUIsQ0FBQyxNQUFELEVBQVMsTUFBVCxDQUFuQixFQUFxQztRQUFBLE9BQU0sTUFBTjtNQUFBLENBQXJDLENBQVg7SUFDRCxDQUZELE1BRU8sSUFBSUEsUUFBUSxDQUFDRSxJQUFULENBQWNHLEVB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