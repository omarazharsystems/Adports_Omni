"use strict";

var _regeneratorRuntime2 = require("@babel/runtime/regenerator");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = speakActivityAndStartDictateOnIncomingActivityFromOthersSaga;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _effects = require("redux-saga/effects");

var _incomingActivity = require("../actions/incomingActivity");

var _DictateState = require("../constants/DictateState");

var _markActivity = _interopRequireDefault(require("../actions/markActivity"));

var _setDictateState = _interopRequireDefault(require("../actions/setDictateState"));

var _shouldSpeakIncomingActivity = _interopRequireDefault(require("../selectors/shouldSpeakIncomingActivity"));

var _speakableActivity = _interopRequireDefault(require("../definitions/speakableActivity"));

var _stopDictate = _interopRequireDefault(require("../actions/stopDictate"));

var _whileConnected = _interopRequireDefault(require("./effects/whileConnected"));

var _marked = /*#__PURE__*/_regeneratorRuntime2.mark(speakActivityAndStartDictateOnIncomingActivityFromOthers),
    _marked2 = /*#__PURE__*/_regeneratorRuntime2.mark(speakActivityAndStartDictateOnIncomingActivityFromOthersSaga);

function speakActivityAndStartDictateOnIncomingActivityFromOthers(_ref) {
  var userID;
  return _regenerator["default"].wrap(function speakActivityAndStartDictateOnIncomingActivityFromOthers$(_context2) {
    while (1) {
      switch (_context2.prev = _context2.next) {
        case 0:
          userID = _ref.userID;
          _context2.next = 3;
          return (0, _effects.takeEvery)(function (_ref2) {
            var payload = _ref2.payload,
                type = _ref2.type;
            return (// In Direct Line, the "role" is not filled (yet), but we do know the user ID.
              // In Direct Line Speech, we do not know the user ID, but "role" is filled with "bot" or "user".
              // Here, we do two checks: the speakable activity must not have user ID, and must not have role === 'user'
              type === _incomingActivity.INCOMING_ACTIVITY && payload.activity.from.id !== userID && payload.activity.from.role !== 'user'
            );
          }, /*#__PURE__*/_regenerator["default"].mark(function _callee(_ref3) {
            var activity, shouldSpeakIncomingActivity, shouldSpeak;
            return _regenerator["default"].wrap(function _callee$(_context) {
              while (1) {
                switch (_context.prev = _context.next) {
                  case 0:
                    activity = _ref3.payload.activity;
                    _context.next = 3;
                    return (0, _effects.select)(_shouldSpeakIncomingActivity["default"]);

                  case 3:
                    shouldSpeakIncomingActivity = _context.sent;
                    shouldSpeak = (0, _speakableActivity["default"])(activity) && shouldSpeakIncomingActivity;

                    if (!(shouldSpeak && (activity.speak || activity.text || ~(activity.attachments || []).findIndex(function (_ref4) {
                      var _ref4$content = _ref4.content;
                      _ref4$content = _ref4$content === void 0 ? {} : _ref4$content;
                      var speak = _ref4$content.speak;
                      return speak;
                    })))) {
                      _context.next = 8;
                      break;
                    }

                    _context.next = 8;
                    return (0, _effects.put)((0, _markActivity["default"])(activity, 'speak', true));

                  case 8:
                    if (!(shouldSpeak && activity.inputHint === 'expectingInput')) {
                      _context.next = 13;
                      break;
                    }

                    _context.next = 11;
                    return (0, _effects.put)((0, _setDictateState["default"])(_DictateState.WILL_START));

                  case 11:
                    _context.next = 16;
                    break;

                  case 13:
                    if (!(activity.inputHint === 'ignoringInput')) {
                      _context.next = 16;
                      break;
                    }

                    _context.next = 16;
                    return (0, _effects.put)((0, _stopDictate["default"])());

                  case 16:
                  case "end":
                    return _context.stop();
                }
              }
            }, _callee);
          }));

        case 3:
        case "end":
          return _context2.stop();
      }
    }
  }, _marked);
}

function speakActivityAndStartDictateOnIncomingActivityFromOthersSaga() {
  return _regenerator["default"].wrap(function speakActivityAndStartDictateOnIncomingActivityFromOthersSaga$(_context3) {
    while (1) {
      switch (_context3.prev = _context3.next) {
        case 0:
          _context3.next = 2;
          return (0, _whileConnected["default"])(speakActivityAndStartDictateOnIncomingActivityFromOthers);

        case 2:
        case "end":
          return _context3.stop();
      }
    }
  }, _marked2);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJzcGVha0FjdGl2aXR5QW5kU3RhcnREaWN0YXRlT25JbmNvbWluZ0FjdGl2aXR5RnJvbU90aGVycyIsInNwZWFrQWN0aXZpdHlBbmRTdGFydERpY3RhdGVPbkluY29taW5nQWN0aXZpdHlGcm9tT3RoZXJzU2FnYSIsInVzZXJJRCIsInRha2VFdmVyeSIsInBheWxvYWQiLCJ0eXBlIiwiSU5DT01JTkdfQUNUSVZJVFkiLCJhY3Rpdml0eSIsImZyb20iLCJpZCIsInJvbGUiLCJzZWxlY3QiLCJzaG91bGRTcGVha0luY29taW5nQWN0aXZpdHlTZWxlY3RvciIsInNob3VsZFNwZWFrSW5jb21pbmdBY3Rpdml0eSIsInNob3VsZFNwZWFrIiwic3BlYWthYmxlQWN0aXZpdHkiLCJzcGVhayIsInRleHQiLCJhdHRhY2htZW50cyIsImZpbmRJbmRleCIsImNvbnRlbnQiLCJwdXQiLCJtYXJrQWN0aXZpdHkiLCJpbnB1dEhpbnQiLCJzZXREaWN0YXRlU3RhdGUiLCJXSUxMX1NUQVJUIiwic3RvcERpY3RhdGUiLCJ3aGlsZUNvbm5lY3RlZCJdLCJzb3VyY2VSb290IjoiY29yZTovLy8iLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zYWdhcy9zcGVha0FjdGl2aXR5QW5kU3RhcnREaWN0YXRlT25JbmNvbWluZ0FjdGl2aXR5RnJvbU90aGVyc1NhZ2EuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcHV0LCBzZWxlY3QsIHRha2VFdmVyeSB9IGZyb20gJ3JlZHV4LXNhZ2EvZWZmZWN0cyc7XG5cbmltcG9ydCB7IElOQ09NSU5HX0FDVElWSVRZIH0gZnJvbSAnLi4vYWN0aW9ucy9pbmNvbWluZ0FjdGl2aXR5JztcbmltcG9ydCB7IFdJTExfU1RBUlQgfSBmcm9tICcuLi9jb25zdGFudHMvRGljdGF0ZVN0YXRlJztcbmltcG9ydCBtYXJrQWN0aXZpdHkgZnJvbSAnLi4vYWN0aW9ucy9tYXJrQWN0aXZpdHknO1xuaW1wb3J0IHNldERpY3RhdGVTdGF0ZSBmcm9tICcuLi9hY3Rpb25zL3NldERpY3RhdGVTdGF0ZSc7XG5pbXBvcnQgc2hvdWxkU3BlYWtJbmNvbWluZ0FjdGl2aXR5U2VsZWN0b3IgZnJvbSAnLi4vc2VsZWN0b3JzL3Nob3VsZFNwZWFrSW5jb21pbmdBY3Rpdml0eSc7XG5pbXBvcnQgc3BlYWthYmxlQWN0aXZpdHkgZnJvbSAnLi4vZGVmaW5pdGlvbnMvc3BlYWthYmxlQWN0aXZpdHknO1xuaW1wb3J0IHN0b3BEaWN0YXRlIGZyb20gJy4uL2FjdGlvbnMvc3RvcERpY3RhdGUnO1xuaW1wb3J0IHdoaWxlQ29ubmVjdGVkIGZyb20gJy4vZWZmZWN0cy93aGlsZUNvbm5lY3RlZCc7XG5cbmZ1bmN0aW9uKiBzcGVha0FjdGl2aXR5QW5kU3RhcnREaWN0YXRlT25JbmNvbWluZ0FjdGl2aXR5RnJvbU90aGVycyh7IHVzZXJJRCB9KSB7XG4gIHlpZWxkIHRha2VFdmVyeShcbiAgICAoeyBwYXlsb2FkLCB0eXBlIH0pID0+XG4gICAgICAvLyBJbiBEaXJlY3QgTGluZSwgdGhlIFwicm9sZVwiIGlzIG5vdCBmaWxsZWQgKHlldCksIGJ1dCB3ZSBkbyBrbm93IHRoZSB1c2VyIElELlxuICAgICAgLy8gSW4gRGlyZWN0IExpbmUgU3BlZWNoLCB3ZSBkbyBub3Qga25vdyB0aGUgdXNlciBJRCwgYnV0IFwicm9sZVwiIGlzIGZpbGxlZCB3aXRoIFwiYm90XCIgb3IgXCJ1c2VyXCIuXG4gICAgICAvLyBIZXJlLCB3ZSBkbyB0d28gY2hlY2tzOiB0aGUgc3BlYWthYmxlIGFjdGl2aXR5IG11c3Qgbm90IGhhdmUgdXNlciBJRCwgYW5kIG11c3Qgbm90IGhhdmUgcm9sZSA9PT0gJ3VzZXInXG4gICAgICB0eXBlID09PSBJTkNPTUlOR19BQ1RJVklUWSAmJiBwYXlsb2FkLmFjdGl2aXR5LmZyb20uaWQgIT09IHVzZXJJRCAmJiBwYXlsb2FkLmFjdGl2aXR5LmZyb20ucm9sZSAhPT0gJ3VzZXInLFxuICAgIGZ1bmN0aW9uKiAoeyBwYXlsb2FkOiB7IGFjdGl2aXR5IH0gfSkge1xuICAgICAgY29uc3Qgc2hvdWxkU3BlYWtJbmNvbWluZ0FjdGl2aXR5ID0geWllbGQgc2VsZWN0KHNob3VsZFNwZWFrSW5jb21pbmdBY3Rpdml0eVNlbGVjdG9yKTtcbiAgICAgIGNvbnN0IHNob3VsZFNwZWFrID0gc3BlYWthYmxlQWN0aXZpdHkoYWN0aXZpdHkpICYmIHNob3VsZFNwZWFrSW5jb21pbmdBY3Rpdml0eTtcblxuICAgICAgaWYgKFxuICAgICAgICBzaG91bGRTcGVhayAmJlxuICAgICAgICAoYWN0aXZpdHkuc3BlYWsgfHxcbiAgICAgICAgICBhY3Rpdml0eS50ZXh0IHx8XG4gICAgICAgICAgfihhY3Rpdml0eS5hdHRhY2htZW50cyB8fCBbXSkuZmluZEluZGV4KCh7IGNvbnRlbnQ6IHsgc3BlYWsgfSA9IHt9IH0pID0+IHNwZWFrKSlcbiAgICAgICkge1xuICAgICAgICB5aWVsZCBwdXQobWFya0FjdGl2aXR5KGFjdGl2aXR5LCAnc3BlYWsnLCB0cnVlKSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChzaG91bGRTcGVhayAmJiBhY3Rpdml0eS5pbnB1dEhpbnQgPT09ICdleHBlY3RpbmdJbnB1dCcpIHtcbiAgICAgICAgeWllbGQgcHV0KHNldERpY3RhdGVTdGF0ZShXSUxMX1NUQVJUKSk7XG4gICAgICB9IGVsc2UgaWYgKGFjdGl2aXR5LmlucHV0SGludCA9PT0gJ2lnbm9yaW5nSW5wdXQnKSB7XG4gICAgICAgIHlpZWxkIHB1dChzdG9wRGljdGF0ZSgpKTtcbiAgICAgIH1cbiAgICB9XG4gICk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uKiBzcGVha0FjdGl2aXR5QW5kU3RhcnREaWN0YXRlT25JbmNvbWluZ0FjdGl2aXR5RnJvbU90aGVyc1NhZ2EoKSB7XG4gIHlpZWxkIHdoaWxlQ29ubmVjdGVkKHNwZWFrQWN0aXZpdHlBbmRTdGFydERpY3RhdGVPbkluY29taW5nQWN0aXZpdHlGcm9tT3RoZXJzKTtcbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztxREFFVUEsd0Q7c0RBNkJlQyw0RDs7QUE3QnpCLFNBQVVELHdEQUFWO0VBQUE7RUFBQTtJQUFBO01BQUE7UUFBQTtVQUFxRUUsTUFBckUsUUFBcUVBLE1BQXJFO1VBQUE7VUFDRSxPQUFNLElBQUFDLGtCQUFBLEVBQ0o7WUFBQSxJQUFHQyxPQUFILFNBQUdBLE9BQUg7WUFBQSxJQUFZQyxJQUFaLFNBQVlBLElBQVo7WUFBQSxPQUNFO2NBQ0E7Y0FDQTtjQUNBQSxJQUFJLEtBQUtDLG1DQUFULElBQThCRixPQUFPLENBQUNHLFFBQVIsQ0FBaUJDLElBQWpCLENBQXNCQyxFQUF0QixLQUE2QlAsTUFBM0QsSUFBcUVFLE9BQU8sQ0FBQ0csUUFBUixDQUFpQkMsSUFBakIsQ0FBc0JFLElBQXRCLEtBQStCO1lBSnRHO1VBQUEsQ0FESSw0Q0FNSjtZQUFBO1lBQUE7Y0FBQTtnQkFBQTtrQkFBQTtvQkFBd0JILFFBQXhCLFNBQWFILE9BQWIsQ0FBd0JHLFFBQXhCO29CQUFBO29CQUNzQyxPQUFNLElBQUFJLGVBQUEsRUFBT0MsdUNBQVAsQ0FBTjs7a0JBRHRDO29CQUNRQywyQkFEUjtvQkFFUUMsV0FGUixHQUVzQixJQUFBQyw2QkFBQSxFQUFrQlIsUUFBbEIsS0FBK0JNLDJCQUZyRDs7b0JBQUEsTUFLSUMsV0FBVyxLQUNWUCxRQUFRLENBQUNTLEtBQVQsSUFDQ1QsUUFBUSxDQUFDVSxJQURWLElBRUMsQ0FBQyxDQUFDVixRQUFRLENBQUNXLFdBQVQsSUFBd0IsRUFBekIsRUFBNkJDLFNBQTdCLENBQXVDO3NCQUFBLDBCQUFHQyxPQUFIO3NCQUFBLDJDQUF3QixFQUF4QjtzQkFBQSxJQUFjSixLQUFkLGlCQUFjQSxLQUFkO3NCQUFBLE9BQWlDQSxLQUFqQztvQkFBQSxDQUF2QyxDQUhRLENBTGY7c0JBQUE7c0JBQUE7b0JBQUE7O29CQUFBO29CQVVJLE9BQU0sSUFBQUssWUFBQSxFQUFJLElBQUFDLHdCQUFBLEVBQWFmLFFBQWIsRUFBdUIsT0FBdkIsRUFBZ0MsSUFBaEMsQ0FBSixDQUFOOztrQkFWSjtvQkFBQSxNQWFNTyxXQUFXLElBQUlQLFFBQVEsQ0FBQ2dCLFNBQVQsS0FBdUIsZ0JBYjVDO3NCQUFBO3NCQUFBO29CQUFBOztvQkFBQTtvQkFjSSxPQUFNLElBQUFGLFlBQUEsRUFBSSxJQUFBRywyQkFBQSxFQUFnQkMsd0JBQWhCLENBQUosQ0FBTjs7a0JBZEo7b0JBQUE7b0JBQUE7O2tCQUFBO29CQUFBLE1BZWFsQixRQUFRLENBQUNnQixTQUFULEtBQXVCLGVBZnBDO3NCQUFBO3NCQUFBO29CQUFBOztvQkFBQTtvQkFnQkksT0FBTSxJQUFBRixZQUFBLEVBQUksSUFBQUssdUJBQUEsR0FBSixDQUFOOztrQkFoQko7a0JBQUE7b0JBQUE7Z0JBQUE7Y0FBQTtZQUFBO1VBQUEsQ0FOSSxFQUFOOztRQURGO1FBQUE7VUFBQTtNQUFBO0lBQUE7RUFBQTtBQUFBOztBQTZCZSxTQUFVekIsNERBQVY7RUFBQTtJQUFBO01BQUE7UUFBQTtVQUFBO1VBQ2IsT0FBTSxJQUFBMEIsMEJBQUEsRUFBZTNCLHdEQUFmLENBQU47O1FBRGE7UUFBQTtVQUFBO01BQUE7SUFBQTtFQUFBO0FBQUEifQ==