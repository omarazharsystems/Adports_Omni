"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; return _typeof = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? function (obj) { return typeof obj; } : function (obj) { return obj && "function" == typeof Symbol && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }, _typeof(obj); }

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireWildcard(require("react"));

var _Context = _interopRequireDefault(require("./private/Context"));

var _getActivityId = _interopRequireDefault(require("./private/getActivityId"));

var _getClientActivityId = _interopRequireDefault(require("./private/getClientActivityId"));

var _uniqueId = _interopRequireDefault(require("./private/uniqueId"));

var _useActivities3 = _interopRequireDefault(require("../../hooks/useActivities"));

var _useContext = _interopRequireDefault(require("./private/useContext"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function _iterableToArrayLimit(arr, i) { var _i = arr == null ? null : typeof Symbol !== "undefined" && arr[Symbol.iterator] || arr["@@iterator"]; if (_i == null) return; var _arr = []; var _n = true; var _d = false; var _s, _e; try { for (_i = _i.call(arr); !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

/**
 * React context composer component to assign a perma-key to every activity.
 * This will support both `useGetActivityByKey` and `useGetKeyByActivity` custom hooks.
 *
 * Today, `activity.id` is only guaranteed for activity from others.
 * Not all activities sent by the local user has `activity.id`.
 *
 * To track outgoing activities, we added `activity.channelData.clientActivityId`.
 *
 * This component will create a local key, which can be used to track both
 * incoming and outgoing activities in a consistent way.
 *
 * Local key are only persisted in memory. On refresh, they will be a new random key.
 */
var ActivityKeyerComposer = function ActivityKeyerComposer(_ref) {
  var children = _ref.children;
  var existingContext = (0, _useContext.default)(false);

  if (existingContext) {
    throw new Error('botframework-webchat internal: <ActivityKeyerComposer> should not be nested.');
  }

  var _useActivities = (0, _useActivities3.default)(),
      _useActivities2 = _slicedToArray(_useActivities, 1),
      activities = _useActivities2[0];

  var activityIdToKeyMapRef = (0, _react.useRef)(Object.freeze(new Map()));
  var activityToKeyMapRef = (0, _react.useRef)(Object.freeze(new Map()));
  var clientActivityIdToKeyMapRef = (0, _react.useRef)(Object.freeze(new Map()));
  var keyToActivityMapRef = (0, _react.useRef)(Object.freeze(new Map())); // TODO: [P1] `useMemoWithPrevious` to check and cache the resulting array if it hasn't changed.

  var activityKeysState = (0, _react.useMemo)(function () {
    var activityIdToKeyMap = activityIdToKeyMapRef.current;
    var activityToKeyMap = activityToKeyMapRef.current;
    var clientActivityIdToKeyMap = clientActivityIdToKeyMapRef.current;
    var nextActivityIdToKeyMap = new Map();
    var nextActivityKeys = [];
    var nextActivityToKeyMap = new Map();
    var nextClientActivityIdToKeyMap = new Map();
    var nextKeyToActivityMap = new Map();
    activities.forEach(function (activity) {
      var activityId = (0, _getActivityId.default)(activity);
      var clientActivityId = (0, _getClientActivityId.default)(activity);
      var key = clientActivityId && clientActivityIdToKeyMap.get(clientActivityId) || activityId && activityIdToKeyMap.get(activityId) || activityToKeyMap.get(activity) || (0, _uniqueId.default)();
      activityId && nextActivityIdToKeyMap.set(activityId, key);
      clientActivityId && nextClientActivityIdToKeyMap.set(clientActivityId, key);
      nextActivityToKeyMap.set(activity, key);
      nextKeyToActivityMap.set(key, activity);
      nextActivityKeys.push(key);
    });
    activityIdToKeyMapRef.current = Object.freeze(nextActivityIdToKeyMap);
    activityToKeyMapRef.current = Object.freeze(nextActivityToKeyMap);
    clientActivityIdToKeyMapRef.current = Object.freeze(nextClientActivityIdToKeyMap);
    keyToActivityMapRef.current = Object.freeze(nextKeyToActivityMap); // `nextActivityKeys` could potentially same as `prevActivityKeys` despite reference differences, we should memoize it.

    return Object.freeze([Object.freeze(nextActivityKeys)]);
  }, [activities, activityIdToKeyMapRef, activityToKeyMapRef, clientActivityIdToKeyMapRef, keyToActivityMapRef]);
  var getActivityByKey = (0, _react.useCallback)(function (key) {
    return key && keyToActivityMapRef.current.get(key);
  }, [keyToActivityMapRef]);
  var getKeyByActivity = (0, _react.useCallback)(function (activity) {
    return activity && activityToKeyMapRef.current.get(activity);
  }, [activityToKeyMapRef]);
  var getKeyByActivityId = (0, _react.useCallback)(function (activityId) {
    return activityId && activityIdToKeyMapRef.current.get(activityId);
  }, [activityIdToKeyMapRef]);
  var contextValue = (0, _react.useMemo)(function () {
    return {
      activityKeysState: activityKeysState,
      getActivityByKey: getActivityByKey,
      getKeyByActivity: getKeyByActivity,
      getKeyByActivityId: getKeyByActivityId
    };
  }, [activityKeysState, getActivityByKey, getKeyByActivity, getKeyByActivityId]);
  var numActivities = activities.length;

  if (activityIdToKeyMapRef.current.size > numActivities) {
    console.warn('botframework-webchat internal assertion: "activityIdToKeyMap.size" should be equal or less than "activities.length".');
  }

  if (activityToKeyMapRef.current.size !== numActivities) {
    console.warn('botframework-webchat internal assertion: "activityToKeyMap.size" should be same as "activities.length".');
  }

  if (clientActivityIdToKeyMapRef.current.size > numActivities) {
    console.warn('botframework-webchat internal assertion: "clientActivityIdToKeyMap.size" should be equal or less than "activities.length".');
  }

  if (keyToActivityMapRef.current.size !== numActivities) {
    console.warn('botframework-webchat internal assertion: "keyToActivityMap.size" should be same as "activities.length".');
  }

  if (activityKeysState[0].length !== numActivities) {
    console.warn('botframework-webchat internal assertion: "activityKeys.length" should be same as "activities.length".');
  }

  return /*#__PURE__*/_react.default.createElement(_Context.default.Provider, {
    value: contextValue
  }, children);
};

ActivityKeyerComposer.defaultProps = {
  children: undefined
};
ActivityKeyerComposer.propTypes = {
  children: _propTypes.default.any
};
var _default = ActivityKeyerComposer;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJBY3Rpdml0eUtleWVyQ29tcG9zZXIiLCJjaGlsZHJlbiIsImV4aXN0aW5nQ29udGV4dCIsInVzZUFjdGl2aXR5S2V5ZXJDb250ZXh0IiwiRXJyb3IiLCJ1c2VBY3Rpdml0aWVzIiwiYWN0aXZpdGllcyIsImFjdGl2aXR5SWRUb0tleU1hcFJlZiIsInVzZVJlZiIsIk9iamVjdCIsImZyZWV6ZSIsIk1hcCIsImFjdGl2aXR5VG9LZXlNYXBSZWYiLCJjbGllbnRBY3Rpdml0eUlkVG9LZXlNYXBSZWYiLCJrZXlUb0FjdGl2aXR5TWFwUmVmIiwiYWN0aXZpdHlLZXlzU3RhdGUiLCJ1c2VNZW1vIiwiYWN0aXZpdHlJZFRvS2V5TWFwIiwiY3VycmVudCIsImFjdGl2aXR5VG9LZXlNYXAiLCJjbGllbnRBY3Rpdml0eUlkVG9LZXlNYXAiLCJuZXh0QWN0aXZpdHlJZFRvS2V5TWFwIiwibmV4dEFjdGl2aXR5S2V5cyIsIm5leHRBY3Rpdml0eVRvS2V5TWFwIiwibmV4dENsaWVudEFjdGl2aXR5SWRUb0tleU1hcCIsIm5leHRLZXlUb0FjdGl2aXR5TWFwIiwiZm9yRWFjaCIsImFjdGl2aXR5IiwiYWN0aXZpdHlJZCIsImdldEFjdGl2aXR5SWQiLCJjbGllbnRBY3Rpdml0eUlkIiwiZ2V0Q2xpZW50QWN0aXZpdHlJZCIsImtleSIsImdldCIsInVuaXF1ZUlkIiwic2V0IiwicHVzaCIsImdldEFjdGl2aXR5QnlLZXkiLCJ1c2VDYWxsYmFjayIsImdldEtleUJ5QWN0aXZpdHkiLCJnZXRLZXlCeUFjdGl2aXR5SWQiLCJjb250ZXh0VmFsdWUiLCJudW1BY3Rpdml0aWVzIiwibGVuZ3RoIiwic2l6ZSIsImNvbnNvbGUiLCJ3YXJuIiwiZGVmYXVsdFByb3BzIiwidW5kZWZpbmVkIiwicHJvcFR5cGVzIiwiUHJvcFR5cGVzIiwiYW55Il0sInNvdXJjZVJvb3QiOiJjb21wb25lbnQ6Ly8vIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcHJvdmlkZXJzL0FjdGl2aXR5S2V5ZXIvQWN0aXZpdHlLZXllckNvbXBvc2VyLnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IFJlYWN0LCB7IHVzZUNhbGxiYWNrLCB1c2VNZW1vLCB1c2VSZWYgfSBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCBBY3Rpdml0eUtleWVyQ29udGV4dCBmcm9tICcuL3ByaXZhdGUvQ29udGV4dCc7XG5pbXBvcnQgZ2V0QWN0aXZpdHlJZCBmcm9tICcuL3ByaXZhdGUvZ2V0QWN0aXZpdHlJZCc7XG5pbXBvcnQgZ2V0Q2xpZW50QWN0aXZpdHlJZCBmcm9tICcuL3ByaXZhdGUvZ2V0Q2xpZW50QWN0aXZpdHlJZCc7XG5pbXBvcnQgdW5pcXVlSWQgZnJvbSAnLi9wcml2YXRlL3VuaXF1ZUlkJztcbmltcG9ydCB1c2VBY3Rpdml0aWVzIGZyb20gJy4uLy4uL2hvb2tzL3VzZUFjdGl2aXRpZXMnO1xuaW1wb3J0IHVzZUFjdGl2aXR5S2V5ZXJDb250ZXh0IGZyb20gJy4vcHJpdmF0ZS91c2VDb250ZXh0JztcblxuaW1wb3J0IHR5cGUgeyBBY3Rpdml0eUtleWVyQ29udGV4dFR5cGUgfSBmcm9tICcuL3ByaXZhdGUvQ29udGV4dCc7XG5pbXBvcnQgdHlwZSB7IEZDLCBQcm9wc1dpdGhDaGlsZHJlbiB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCB0eXBlIHsgV2ViQ2hhdEFjdGl2aXR5IH0gZnJvbSAnYm90ZnJhbWV3b3JrLXdlYmNoYXQtY29yZSc7XG5cbnR5cGUgQWN0aXZpdHlJZFRvS2V5TWFwID0gTWFwPHN0cmluZywgc3RyaW5nPjtcbnR5cGUgQWN0aXZpdHlUb0tleU1hcCA9IE1hcDxXZWJDaGF0QWN0aXZpdHksIHN0cmluZz47XG50eXBlIENsaWVudEFjdGl2aXR5SWRUb0tleU1hcCA9IE1hcDxzdHJpbmcsIHN0cmluZz47XG50eXBlIEtleVRvQWN0aXZpdHlNYXAgPSBNYXA8c3RyaW5nLCBXZWJDaGF0QWN0aXZpdHk+O1xuXG4vKipcbiAqIFJlYWN0IGNvbnRleHQgY29tcG9zZXIgY29tcG9uZW50IHRvIGFzc2lnbiBhIHBlcm1hLWtleSB0byBldmVyeSBhY3Rpdml0eS5cbiAqIFRoaXMgd2lsbCBzdXBwb3J0IGJvdGggYHVzZUdldEFjdGl2aXR5QnlLZXlgIGFuZCBgdXNlR2V0S2V5QnlBY3Rpdml0eWAgY3VzdG9tIGhvb2tzLlxuICpcbiAqIFRvZGF5LCBgYWN0aXZpdHkuaWRgIGlzIG9ubHkgZ3VhcmFudGVlZCBmb3IgYWN0aXZpdHkgZnJvbSBvdGhlcnMuXG4gKiBOb3QgYWxsIGFjdGl2aXRpZXMgc2VudCBieSB0aGUgbG9jYWwgdXNlciBoYXMgYGFjdGl2aXR5LmlkYC5cbiAqXG4gKiBUbyB0cmFjayBvdXRnb2luZyBhY3Rpdml0aWVzLCB3ZSBhZGRlZCBgYWN0aXZpdHkuY2hhbm5lbERhdGEuY2xpZW50QWN0aXZpdHlJZGAuXG4gKlxuICogVGhpcyBjb21wb25lbnQgd2lsbCBjcmVhdGUgYSBsb2NhbCBrZXksIHdoaWNoIGNhbiBiZSB1c2VkIHRvIHRyYWNrIGJvdGhcbiAqIGluY29taW5nIGFuZCBvdXRnb2luZyBhY3Rpdml0aWVzIGluIGEgY29uc2lzdGVudCB3YXkuXG4gKlxuICogTG9jYWwga2V5IGFyZSBvbmx5IHBlcnNpc3RlZCBpbiBtZW1vcnkuIE9uIHJlZnJlc2gsIHRoZXkgd2lsbCBiZSBhIG5ldyByYW5kb20ga2V5LlxuICovXG5jb25zdCBBY3Rpdml0eUtleWVyQ29tcG9zZXI6IEZDPFByb3BzV2l0aENoaWxkcmVuPHt9Pj4gPSAoeyBjaGlsZHJlbiB9KSA9PiB7XG4gIGNvbnN0IGV4aXN0aW5nQ29udGV4dCA9IHVzZUFjdGl2aXR5S2V5ZXJDb250ZXh0KGZhbHNlKTtcblxuICBpZiAoZXhpc3RpbmdDb250ZXh0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdib3RmcmFtZXdvcmstd2ViY2hhdCBpbnRlcm5hbDogPEFjdGl2aXR5S2V5ZXJDb21wb3Nlcj4gc2hvdWxkIG5vdCBiZSBuZXN0ZWQuJyk7XG4gIH1cblxuICBjb25zdCBbYWN0aXZpdGllc10gPSB1c2VBY3Rpdml0aWVzKCk7XG4gIGNvbnN0IGFjdGl2aXR5SWRUb0tleU1hcFJlZiA9IHVzZVJlZjxSZWFkb25seTxBY3Rpdml0eUlkVG9LZXlNYXA+PihPYmplY3QuZnJlZXplKG5ldyBNYXAoKSkpO1xuICBjb25zdCBhY3Rpdml0eVRvS2V5TWFwUmVmID0gdXNlUmVmPFJlYWRvbmx5PEFjdGl2aXR5VG9LZXlNYXA+PihPYmplY3QuZnJlZXplKG5ldyBNYXAoKSkpO1xuICBjb25zdCBjbGllbnRBY3Rpdml0eUlkVG9LZXlNYXBSZWYgPSB1c2VSZWY8UmVhZG9ubHk8Q2xpZW50QWN0aXZpdHlJZFRvS2V5TWFwPj4oT2JqZWN0LmZyZWV6ZShuZXcgTWFwKCkpKTtcbiAgY29uc3Qga2V5VG9BY3Rpdml0eU1hcFJlZiA9IHVzZVJlZjxSZWFkb25seTxLZXlUb0FjdGl2aXR5TWFwPj4oT2JqZWN0LmZyZWV6ZShuZXcgTWFwKCkpKTtcblxuICAvLyBUT0RPOiBbUDFdIGB1c2VNZW1vV2l0aFByZXZpb3VzYCB0byBjaGVjayBhbmQgY2FjaGUgdGhlIHJlc3VsdGluZyBhcnJheSBpZiBpdCBoYXNuJ3QgY2hhbmdlZC5cbiAgY29uc3QgYWN0aXZpdHlLZXlzU3RhdGUgPSB1c2VNZW1vPHJlYWRvbmx5IFtyZWFkb25seSBzdHJpbmdbXV0+KCgpID0+IHtcbiAgICBjb25zdCB7IGN1cnJlbnQ6IGFjdGl2aXR5SWRUb0tleU1hcCB9ID0gYWN0aXZpdHlJZFRvS2V5TWFwUmVmO1xuICAgIGNvbnN0IHsgY3VycmVudDogYWN0aXZpdHlUb0tleU1hcCB9ID0gYWN0aXZpdHlUb0tleU1hcFJlZjtcbiAgICBjb25zdCB7IGN1cnJlbnQ6IGNsaWVudEFjdGl2aXR5SWRUb0tleU1hcCB9ID0gY2xpZW50QWN0aXZpdHlJZFRvS2V5TWFwUmVmO1xuICAgIGNvbnN0IG5leHRBY3Rpdml0eUlkVG9LZXlNYXA6IEFjdGl2aXR5SWRUb0tleU1hcCA9IG5ldyBNYXAoKTtcbiAgICBjb25zdCBuZXh0QWN0aXZpdHlLZXlzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IG5leHRBY3Rpdml0eVRvS2V5TWFwOiBBY3Rpdml0eVRvS2V5TWFwID0gbmV3IE1hcCgpO1xuICAgIGNvbnN0IG5leHRDbGllbnRBY3Rpdml0eUlkVG9LZXlNYXA6IENsaWVudEFjdGl2aXR5SWRUb0tleU1hcCA9IG5ldyBNYXAoKTtcbiAgICBjb25zdCBuZXh0S2V5VG9BY3Rpdml0eU1hcDogS2V5VG9BY3Rpdml0eU1hcCA9IG5ldyBNYXAoKTtcblxuICAgIGFjdGl2aXRpZXMuZm9yRWFjaChhY3Rpdml0eSA9PiB7XG4gICAgICBjb25zdCBhY3Rpdml0eUlkID0gZ2V0QWN0aXZpdHlJZChhY3Rpdml0eSk7XG4gICAgICBjb25zdCBjbGllbnRBY3Rpdml0eUlkID0gZ2V0Q2xpZW50QWN0aXZpdHlJZChhY3Rpdml0eSk7XG5cbiAgICAgIGNvbnN0IGtleSA9XG4gICAgICAgIChjbGllbnRBY3Rpdml0eUlkICYmIGNsaWVudEFjdGl2aXR5SWRUb0tleU1hcC5nZXQoY2xpZW50QWN0aXZpdHlJZCkpIHx8XG4gICAgICAgIChhY3Rpdml0eUlkICYmIGFjdGl2aXR5SWRUb0tleU1hcC5nZXQoYWN0aXZpdHlJZCkpIHx8XG4gICAgICAgIGFjdGl2aXR5VG9LZXlNYXAuZ2V0KGFjdGl2aXR5KSB8fFxuICAgICAgICB1bmlxdWVJZCgpO1xuXG4gICAgICBhY3Rpdml0eUlkICYmIG5leHRBY3Rpdml0eUlkVG9LZXlNYXAuc2V0KGFjdGl2aXR5SWQsIGtleSk7XG4gICAgICBjbGllbnRBY3Rpdml0eUlkICYmIG5leHRDbGllbnRBY3Rpdml0eUlkVG9LZXlNYXAuc2V0KGNsaWVudEFjdGl2aXR5SWQsIGtleSk7XG4gICAgICBuZXh0QWN0aXZpdHlUb0tleU1hcC5zZXQoYWN0aXZpdHksIGtleSk7XG4gICAgICBuZXh0S2V5VG9BY3Rpdml0eU1hcC5zZXQoa2V5LCBhY3Rpdml0eSk7XG4gICAgICBuZXh0QWN0aXZpdHlLZXlzLnB1c2goa2V5KTtcbiAgICB9KTtcblxuICAgIGFjdGl2aXR5SWRUb0tleU1hcFJlZi5jdXJyZW50ID0gT2JqZWN0LmZyZWV6ZShuZXh0QWN0aXZpdHlJZFRvS2V5TWFwKTtcbiAgICBhY3Rpdml0eVRvS2V5TWFwUmVmLmN1cnJlbnQgPSBPYmplY3QuZnJlZXplKG5leHRBY3Rpdml0eVRvS2V5TWFwKTtcbiAgICBjbGllbnRBY3Rpdml0eUlkVG9LZXlNYXBSZWYuY3VycmVudCA9IE9iamVjdC5mcmVlemUobmV4dENsaWVudEFjdGl2aXR5SWRUb0tleU1hcCk7XG4gICAga2V5VG9BY3Rpdml0eU1hcFJlZi5jdXJyZW50ID0gT2JqZWN0LmZyZWV6ZShuZXh0S2V5VG9BY3Rpdml0eU1hcCk7XG5cbiAgICAvLyBgbmV4dEFjdGl2aXR5S2V5c2AgY291bGQgcG90ZW50aWFsbHkgc2FtZSBhcyBgcHJldkFjdGl2aXR5S2V5c2AgZGVzcGl0ZSByZWZlcmVuY2UgZGlmZmVyZW5jZXMsIHdlIHNob3VsZCBtZW1vaXplIGl0LlxuICAgIHJldHVybiBPYmplY3QuZnJlZXplKFtPYmplY3QuZnJlZXplKG5leHRBY3Rpdml0eUtleXMpXSkgYXMgcmVhZG9ubHkgW3JlYWRvbmx5IHN0cmluZ1tdXTtcbiAgfSwgW2FjdGl2aXRpZXMsIGFjdGl2aXR5SWRUb0tleU1hcFJlZiwgYWN0aXZpdHlUb0tleU1hcFJlZiwgY2xpZW50QWN0aXZpdHlJZFRvS2V5TWFwUmVmLCBrZXlUb0FjdGl2aXR5TWFwUmVmXSk7XG5cbiAgY29uc3QgZ2V0QWN0aXZpdHlCeUtleTogKGtleT86IHN0cmluZykgPT4gdW5kZWZpbmVkIHwgV2ViQ2hhdEFjdGl2aXR5ID0gdXNlQ2FsbGJhY2soXG4gICAgKGtleT86IHN0cmluZyk6IHVuZGVmaW5lZCB8IFdlYkNoYXRBY3Rpdml0eSA9PiBrZXkgJiYga2V5VG9BY3Rpdml0eU1hcFJlZi5jdXJyZW50LmdldChrZXkpLFxuICAgIFtrZXlUb0FjdGl2aXR5TWFwUmVmXVxuICApO1xuXG4gIGNvbnN0IGdldEtleUJ5QWN0aXZpdHk6IChhY3Rpdml0eT86IFdlYkNoYXRBY3Rpdml0eSkgPT4gc3RyaW5nIHwgdW5kZWZpbmVkID0gdXNlQ2FsbGJhY2soXG4gICAgKGFjdGl2aXR5PzogV2ViQ2hhdEFjdGl2aXR5KSA9PiBhY3Rpdml0eSAmJiBhY3Rpdml0eVRvS2V5TWFwUmVmLmN1cnJlbnQuZ2V0KGFjdGl2aXR5KSxcbiAgICBbYWN0aXZpdHlUb0tleU1hcFJlZl1cbiAgKTtcblxuICBjb25zdCBnZXRLZXlCeUFjdGl2aXR5SWQ6IChhY3Rpdml0eUlkPzogc3RyaW5nKSA9PiBzdHJpbmcgfCB1bmRlZmluZWQgPSB1c2VDYWxsYmFjayhcbiAgICAoYWN0aXZpdHlJZD86IHN0cmluZykgPT4gYWN0aXZpdHlJZCAmJiBhY3Rpdml0eUlkVG9LZXlNYXBSZWYuY3VycmVudC5nZXQoYWN0aXZpdHlJZCksXG4gICAgW2FjdGl2aXR5SWRUb0tleU1hcFJlZl1cbiAgKTtcblxuICBjb25zdCBjb250ZXh0VmFsdWUgPSB1c2VNZW1vPEFjdGl2aXR5S2V5ZXJDb250ZXh0VHlwZT4oXG4gICAgKCkgPT4gKHtcbiAgICAgIGFjdGl2aXR5S2V5c1N0YXRlLFxuICAgICAgZ2V0QWN0aXZpdHlCeUtleSxcbiAgICAgIGdldEtleUJ5QWN0aXZpdHksXG4gICAgICBnZXRLZXlCeUFjdGl2aXR5SWRcbiAgICB9KSxcbiAgICBbYWN0aXZpdHlLZXlzU3RhdGUsIGdldEFjdGl2aXR5QnlLZXksIGdldEtleUJ5QWN0aXZpdHksIGdldEtleUJ5QWN0aXZpdHlJZF1cbiAgKTtcblxuICBjb25zdCB7IGxlbmd0aDogbnVtQWN0aXZpdGllcyB9ID0gYWN0aXZpdGllcztcblxuICBpZiAoYWN0aXZpdHlJZFRvS2V5TWFwUmVmLmN1cnJlbnQuc2l6ZSA+IG51bUFjdGl2aXRpZXMpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnYm90ZnJhbWV3b3JrLXdlYmNoYXQgaW50ZXJuYWwgYXNzZXJ0aW9uOiBcImFjdGl2aXR5SWRUb0tleU1hcC5zaXplXCIgc2hvdWxkIGJlIGVxdWFsIG9yIGxlc3MgdGhhbiBcImFjdGl2aXRpZXMubGVuZ3RoXCIuJ1xuICAgICk7XG4gIH1cblxuICBpZiAoYWN0aXZpdHlUb0tleU1hcFJlZi5jdXJyZW50LnNpemUgIT09IG51bUFjdGl2aXRpZXMpIHtcbiAgICBjb25zb2xlLndhcm4oXG4gICAgICAnYm90ZnJhbWV3b3JrLXdlYmNoYXQgaW50ZXJuYWwgYXNzZXJ0aW9uOiBcImFjdGl2aXR5VG9LZXlNYXAuc2l6ZVwiIHNob3VsZCBiZSBzYW1lIGFzIFwiYWN0aXZpdGllcy5sZW5ndGhcIi4nXG4gICAgKTtcbiAgfVxuXG4gIGlmIChjbGllbnRBY3Rpdml0eUlkVG9LZXlNYXBSZWYuY3VycmVudC5zaXplID4gbnVtQWN0aXZpdGllcykge1xuICAgIGNvbnNvbGUud2FybihcbiAgICAgICdib3RmcmFtZXdvcmstd2ViY2hhdCBpbnRlcm5hbCBhc3NlcnRpb246IFwiY2xpZW50QWN0aXZpdHlJZFRvS2V5TWFwLnNpemVcIiBzaG91bGQgYmUgZXF1YWwgb3IgbGVzcyB0aGFuIFwiYWN0aXZpdGllcy5sZW5ndGhcIi4nXG4gICAgKTtcbiAgfVxuXG4gIGlmIChrZXlUb0FjdGl2aXR5TWFwUmVmLmN1cnJlbnQuc2l6ZSAhPT0gbnVtQWN0aXZpdGllcykge1xuICAgIGNvbnNvbGUud2FybihcbiAgICAgICdib3RmcmFtZXdvcmstd2ViY2hhdCBpbnRlcm5hbCBhc3NlcnRpb246IFwia2V5VG9BY3Rpdml0eU1hcC5zaXplXCIgc2hvdWxkIGJlIHNhbWUgYXMgXCJhY3Rpdml0aWVzLmxlbmd0aFwiLidcbiAgICApO1xuICB9XG5cbiAgaWYgKGFjdGl2aXR5S2V5c1N0YXRlWzBdLmxlbmd0aCAhPT0gbnVtQWN0aXZpdGllcykge1xuICAgIGNvbnNvbGUud2FybihcbiAgICAgICdib3RmcmFtZXdvcmstd2ViY2hhdCBpbnRlcm5hbCBhc3NlcnRpb246IFwiYWN0aXZpdHlLZXlzLmxlbmd0aFwiIHNob3VsZCBiZSBzYW1lIGFzIFwiYWN0aXZpdGllcy5sZW5ndGhcIi4nXG4gICAgKTtcbiAgfVxuXG4gIHJldHVybiA8QWN0aXZpdHlLZXllckNvbnRleHQuUHJvdmlkZXIgdmFsdWU9e2NvbnRleHRWYWx1ZX0+e2NoaWxkcmVufTwvQWN0aXZpdHlLZXllckNvbnRleHQuUHJvdmlkZXI+O1xufTtcblxuQWN0aXZpdHlLZXllckNvbXBvc2VyLmRlZmF1bHRQcm9wcyA9IHtcbiAgY2hpbGRyZW46IHVuZGVmaW5lZFxufTtcblxuQWN0aXZpdHlLZXllckNvbXBvc2VyLnByb3BUeXBlcyA9IHtcbiAgY2hpbGRyZW46IFByb3BUeXBlcy5hbnlcbn07XG5cbmV4cG9ydCBkZWZhdWx0IEFjdGl2aXR5S2V5ZXJDb21wb3NlcjtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBV0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLHFCQUFnRCxHQUFHLFNBQW5EQSxxQkFBbUQsT0FBa0I7RUFBQSxJQUFmQyxRQUFlLFFBQWZBLFFBQWU7RUFDekUsSUFBTUMsZUFBZSxHQUFHLElBQUFDLG1CQUFBLEVBQXdCLEtBQXhCLENBQXhCOztFQUVBLElBQUlELGVBQUosRUFBcUI7SUFDbkIsTUFBTSxJQUFJRSxLQUFKLENBQVUsOEVBQVYsQ0FBTjtFQUNEOztFQUVELHFCQUFxQixJQUFBQyx1QkFBQSxHQUFyQjtFQUFBO0VBQUEsSUFBT0MsVUFBUDs7RUFDQSxJQUFNQyxxQkFBcUIsR0FBRyxJQUFBQyxhQUFBLEVBQXFDQyxNQUFNLENBQUNDLE1BQVAsQ0FBYyxJQUFJQyxHQUFKLEVBQWQsQ0FBckMsQ0FBOUI7RUFDQSxJQUFNQyxtQkFBbUIsR0FBRyxJQUFBSixhQUFBLEVBQW1DQyxNQUFNLENBQUNDLE1BQVAsQ0FBYyxJQUFJQyxHQUFKLEVBQWQsQ0FBbkMsQ0FBNUI7RUFD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