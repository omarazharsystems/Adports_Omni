"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; return _typeof = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? function (obj) { return typeof obj; } : function (obj) { return obj && "function" == typeof Symbol && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }, _typeof(obj); }

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _botframeworkWebchatApi = require("botframework-webchat-api");

var _useRefFrom = require("use-ref-from");

var _classnames = _interopRequireDefault(require("classnames"));

var _react = _interopRequireWildcard(require("react"));

var _Context = _interopRequireDefault(require("./private/Context"));

var _useFocus = _interopRequireDefault(require("../../../hooks/useFocus"));

var _useScrollToEnd = _interopRequireDefault(require("../../../hooks/useScrollToEnd"));

var _useStyleToEmotionObject = _interopRequireDefault(require("../../../hooks/internal/useStyleToEmotionObject"));

var _useUniqueId = _interopRequireDefault(require("../../../hooks/internal/useUniqueId"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _unsupportedIterableToArray(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function _iterableToArrayLimit(arr, i) { var _i = arr == null ? null : typeof Symbol !== "undefined" && arr[Symbol.iterator] || arr["@@iterator"]; if (_i == null) return; var _arr = []; var _n = true; var _d = false; var _s, _e; try { for (_i = _i.call(arr); !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

var useConnectivityStatus = _botframeworkWebchatApi.hooks.useConnectivityStatus,
    useLocalizer = _botframeworkWebchatApi.hooks.useLocalizer,
    usePonyfill = _botframeworkWebchatApi.hooks.usePonyfill,
    useSendBoxValue = _botframeworkWebchatApi.hooks.useSendBoxValue,
    useSubmitSendBox = _botframeworkWebchatApi.hooks.useSubmitSendBox;
var SUBMIT_ERROR_MESSAGE_STYLE = {
  '&.webchat__submit-error-message': {
    // .sr-only - This component is intended to be invisible to the visual Web Chat user, but read by the AT when using a screen reader
    color: 'transparent',
    height: 1,
    overflow: 'hidden',
    position: 'absolute',
    // We need to set top: 0, otherwise, it will repro:
    // - Run NVDA
    // - Make the transcript long enough to show the scrollbar
    // - Press SHIFT-TAB, focus on upload button
    // - Press up arrow multiple times
    top: 0,
    whiteSpace: 'nowrap',
    width: 1
  }
}; // False positive: we are using `setTimeout` as a type.
// eslint-disable-next-line no-restricted-globals

var TIME_TO_QUEUE_ERROR_MESSAGE = 500;
var TIME_TO_RESET_ERROR_MESSAGE = 50; // This component is marked as internal because it is not fully implemented and is not ready to be consumed publicly.
// When it is done, it should provide and replace all the functionalities we did in Redux, including but not limited to:
// - Speech interims
// - Maintain text box value
// - Multiple <SendBoxComposer> in a single Web Chat instance
//    - Web devs should be able to put an individual send box instance into an activity
//    - The send box instance in the activity, should be separated from the bottommost send box
//    - The valued typed inside the activity, should be separated from the value typed into the bottommost send box
// In the old days, we use Redux to keep the send box state.
// However, when web devs put 2 send box on their page, it makes things complex because both send boxes will interact with each other.
// We would rather have them separate. If web devs want them to interact with each other, they will do the wiring themselves.

// TODO: [P2] Complete this component.
var SendBoxComposer = function SendBoxComposer(_ref) {
  var children = _ref.children;

  var _usePonyfill = usePonyfill(),
      _usePonyfill2 = _slicedToArray(_usePonyfill, 1),
      _usePonyfill2$ = _usePonyfill2[0],
      clearTimeout = _usePonyfill2$.clearTimeout,
      setTimeout = _usePonyfill2$.setTimeout;

  var _useConnectivityStatu = useConnectivityStatus(),
      _useConnectivityStatu2 = _slicedToArray(_useConnectivityStatu, 1),
      connectivityStatus = _useConnectivityStatu2[0];

  var _useState = (0, _react.useState)(false),
      _useState2 = _slicedToArray(_useState, 2),
      error = _useState2[0],
      setError = _useState2[1];

  var _useSendBoxValue = useSendBoxValue(),
      _useSendBoxValue2 = _slicedToArray(_useSendBoxValue, 1),
      sendBoxValue = _useSendBoxValue2[0];

  var apiSubmitSendBox = useSubmitSendBox();
  var focus = (0, _useFocus.default)();
  var localize = useLocalizer();
  var scrollToEnd = (0, _useScrollToEnd.default)();
  var styleToEmotionObject = (0, _useStyleToEmotionObject.default)();
  var submitErrorMessageId = (0, _useUniqueId.default)('webchat__send-box__error-message-id');
  var timeoutRef = (0, _react.useRef)(undefined);
  var errorMessageStringMap = (0, _react.useMemo)(function () {
    return Object.freeze(new Map().set('empty', localize('SEND_BOX_IS_EMPTY_TOOLTIP_ALT')) // TODO: [P0] We should add a new string for "Cannot send message while offline."
    .set('offline', localize('CONNECTIVITY_STATUS_ALT_FATAL')));
  }, [localize]);
  var focusRef = (0, _useRefFrom.useRefFrom)(focus);
  var scrollToEndRef = (0, _useRefFrom.useRefFrom)(scrollToEnd);
  var setErrorRef = (0, _react.useRef)(setError);
  var submitErrorMessageClassName = styleToEmotionObject(SUBMIT_ERROR_MESSAGE_STYLE) + '';
  var submitErrorMessageIdState = (0, _react.useMemo)(function () {
    return Object.freeze([error ? submitErrorMessageId : undefined]);
  }, [error, submitErrorMessageId]);
  setErrorRef.current = setError;
  var submitErrorRef = (0, _useRefFrom.useRefFrom)(connectivityStatus !== 'connected' && connectivityStatus !== 'reconnected' ? 'offline' : !sendBoxValue ? 'empty' : undefined);
  var submit = (0, _react.useCallback)(function () {
    var _focusRef$current;

    var _ref2 = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},
        setFocus = _ref2.setFocus;

    (setFocus === 'main' || setFocus === 'sendBox' || setFocus === 'sendBoxWithoutKeyboard') && ((_focusRef$current = focusRef.current) === null || _focusRef$current === void 0 ? void 0 : _focusRef$current.call(focusRef, setFocus === 'main' || setFocus === 'sendBox' ? setFocus : 'sendBoxWithoutKeyboard'));
    var submitError = submitErrorRef.current;

    if (submitError) {
      var _setErrorRef$current;

      timeoutRef.current && timeoutRef.current.forEach(clearTimeout);
      (_setErrorRef$current = setErrorRef.current) === null || _setErrorRef$current === void 0 ? void 0 : _setErrorRef$current.call(setErrorRef, false);
      timeoutRef.current = Object.freeze([setTimeout(function () {
        var _setErrorRef$current2;

        return (_setErrorRef$current2 = setErrorRef.current) === null || _setErrorRef$current2 === void 0 ? void 0 : _setErrorRef$current2.call(setErrorRef, submitError);
      }, TIME_TO_RESET_ERROR_MESSAGE), setTimeout(function () {
        var _setErrorRef$current3;

        return (_setErrorRef$current3 = setErrorRef.current) === null || _setErrorRef$current3 === void 0 ? void 0 : _setErrorRef$current3.call(setErrorRef, false);
      }, TIME_TO_QUEUE_ERROR_MESSAGE)]);
    } else {
      var _scrollToEndRef$curre;

      (_scrollToEndRef$curre = scrollToEndRef.current) === null || _scrollToEndRef$curre === void 0 ? void 0 : _scrollToEndRef$curre.call(scrollToEndRef);
      apiSubmitSendBox();
    }
  }, [apiSubmitSendBox, clearTimeout, focusRef, scrollToEndRef, setErrorRef, setTimeout, submitErrorRef, timeoutRef]);
  (0, _react.useEffect)( // Prevent `setTimeout()` from firing after unmount.
  function () {
    return function () {
      setErrorRef.current = undefined;
    };
  }, [setErrorRef]);
  var context = (0, _react.useMemo)(function () {
    return {
      submit: submit,
      submitErrorMessageIdState: submitErrorMessageIdState
    };
  }, [submit, submitErrorMessageIdState]);
  return /*#__PURE__*/_react.default.createElement(_Context.default.Provider, {
    value: context
  }, children, /*#__PURE__*/_react.default.createElement("span", {
    className: (0, _classnames.default)('webchat__submit-error-message', submitErrorMessageClassName) // "id" is required for "aria-errormessage" as IDREF.
    // eslint-disable-next-line react/forbid-dom-props
    ,
    id: submitErrorMessageId,
    role: "alert"
  }, error ? errorMessageStringMap.get(error) : ''));
};

var _default = SendBoxComposer;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJ1c2VDb25uZWN0aXZpdHlTdGF0dXMiLCJob29rcyIsInVzZUxvY2FsaXplciIsInVzZVBvbnlmaWxsIiwidXNlU2VuZEJveFZhbHVlIiwidXNlU3VibWl0U2VuZEJveCIsIlNVQk1JVF9FUlJPUl9NRVNTQUdFX1NUWUxFIiwiY29sb3IiLCJoZWlnaHQiLCJvdmVyZmxvdyIsInBvc2l0aW9uIiwidG9wIiwid2hpdGVTcGFjZSIsIndpZHRoIiwiVElNRV9UT19RVUVVRV9FUlJPUl9NRVNTQUdFIiwiVElNRV9UT19SRVNFVF9FUlJPUl9NRVNTQUdFIiwiU2VuZEJveENvbXBvc2VyIiwiY2hpbGRyZW4iLCJjbGVhclRpbWVvdXQiLCJzZXRUaW1lb3V0IiwiY29ubmVjdGl2aXR5U3RhdHVzIiwidXNlU3RhdGUiLCJlcnJvciIsInNldEVycm9yIiwic2VuZEJveFZhbHVlIiwiYXBpU3VibWl0U2VuZEJveCIsImZvY3VzIiwidXNlRm9jdXMiLCJsb2NhbGl6ZSIsInNjcm9sbFRvRW5kIiwidXNlU2Nyb2xsVG9FbmQiLCJzdHlsZVRvRW1vdGlvbk9iamVjdCIsInVzZVN0eWxlVG9FbW90aW9uT2JqZWN0Iiwic3VibWl0RXJyb3JNZXNzYWdlSWQiLCJ1c2VVbmlxdWVJZCIsInRpbWVvdXRSZWYiLCJ1c2VSZWYiLCJ1bmRlZmluZWQiLCJlcnJvck1lc3NhZ2VTdHJpbmdNYXAiLCJ1c2VNZW1vIiwiT2JqZWN0IiwiZnJlZXplIiwiTWFwIiwic2V0IiwiZm9jdXNSZWYiLCJ1c2VSZWZGcm9tIiwic2Nyb2xsVG9FbmRSZWYiLCJzZXRFcnJvclJlZiIsInN1Ym1pdEVycm9yTWVzc2FnZUNsYXNzTmFtZSIsInN1Ym1pdEVycm9yTWVzc2FnZUlkU3RhdGUiLCJjdXJyZW50Iiwic3VibWl0RXJyb3JSZWYiLCJzdWJtaXQiLCJ1c2VDYWxsYmFjayIsInNldEZvY3VzIiwic3VibWl0RXJyb3IiLCJmb3JFYWNoIiwidXNlRWZmZWN0IiwiY29udGV4dCIsImNsYXNzTmFtZXMiLCJnZXQiXSwic291cmNlUm9vdCI6ImNvbXBvbmVudDovLy8iLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9wcm92aWRlcnMvaW50ZXJuYWwvU2VuZEJveC9TZW5kQm94Q29tcG9zZXIudHN4Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGhvb2tzIH0gZnJvbSAnYm90ZnJhbWV3b3JrLXdlYmNoYXQtYXBpJztcbmltcG9ydCB7IHVzZVJlZkZyb20gfSBmcm9tICd1c2UtcmVmLWZyb20nO1xuaW1wb3J0IGNsYXNzTmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgUmVhY3QsIHsgdXNlQ2FsbGJhY2ssIHVzZUVmZmVjdCwgdXNlTWVtbywgdXNlUmVmLCB1c2VTdGF0ZSB9IGZyb20gJ3JlYWN0JztcblxuaW1wb3J0IFNlbmRCb3hDb250ZXh0IGZyb20gJy4vcHJpdmF0ZS9Db250ZXh0JztcbmltcG9ydCB1c2VGb2N1cyBmcm9tICcuLi8uLi8uLi9ob29rcy91c2VGb2N1cyc7XG5pbXBvcnQgdXNlU2Nyb2xsVG9FbmQgZnJvbSAnLi4vLi4vLi4vaG9va3MvdXNlU2Nyb2xsVG9FbmQnO1xuaW1wb3J0IHVzZVN0eWxlVG9FbW90aW9uT2JqZWN0IGZyb20gJy4uLy4uLy4uL2hvb2tzL2ludGVybmFsL3VzZVN0eWxlVG9FbW90aW9uT2JqZWN0JztcbmltcG9ydCB1c2VVbmlxdWVJZCBmcm9tICcuLi8uLi8uLi9ob29rcy9pbnRlcm5hbC91c2VVbmlxdWVJZCc7XG5cbmltcG9ydCB0eXBlIHsgQ29udGV4dFR5cGUsIFNlbmRFcnJvciB9IGZyb20gJy4vcHJpdmF0ZS90eXBlcyc7XG5pbXBvcnQgdHlwZSB7IFByb3BzV2l0aENoaWxkcmVuIH0gZnJvbSAncmVhY3QnO1xuXG5jb25zdCB7IHVzZUNvbm5lY3Rpdml0eVN0YXR1cywgdXNlTG9jYWxpemVyLCB1c2VQb255ZmlsbCwgdXNlU2VuZEJveFZhbHVlLCB1c2VTdWJtaXRTZW5kQm94IH0gPSBob29rcztcblxuY29uc3QgU1VCTUlUX0VSUk9SX01FU1NBR0VfU1RZTEUgPSB7XG4gICcmLndlYmNoYXRfX3N1Ym1pdC1lcnJvci1tZXNzYWdlJzoge1xuICAgIC8vIC5zci1vbmx5IC0gVGhpcyBjb21wb25lbnQgaXMgaW50ZW5kZWQgdG8gYmUgaW52aXNpYmxlIHRvIHRoZSB2aXN1YWwgV2ViIENoYXQgdXNlciwgYnV0IHJlYWQgYnkgdGhlIEFUIHdoZW4gdXNpbmcgYSBzY3JlZW4gcmVhZGVyXG4gICAgY29sb3I6ICd0cmFuc3BhcmVudCcsXG4gICAgaGVpZ2h0OiAxLFxuICAgIG92ZXJmbG93OiAnaGlkZGVuJyxcbiAgICBwb3NpdGlvbjogJ2Fic29sdXRlJyxcbiAgICAvLyBXZSBuZWVkIHRvIHNldCB0b3A6IDAsIG90aGVyd2lzZSwgaXQgd2lsbCByZXBybzpcbiAgICAvLyAtIFJ1biBOVkRBXG4gICAgLy8gLSBNYWtlIHRoZSB0cmFuc2NyaXB0IGxvbmcgZW5vdWdoIHRvIHNob3cgdGhlIHNjcm9sbGJhclxuICAgIC8vIC0gUHJlc3MgU0hJRlQtVEFCLCBmb2N1cyBvbiB1cGxvYWQgYnV0dG9uXG4gICAgLy8gLSBQcmVzcyB1cCBhcnJvdyBtdWx0aXBsZSB0aW1lc1xuICAgIHRvcDogMCxcbiAgICB3aGl0ZVNwYWNlOiAnbm93cmFwJyxcbiAgICB3aWR0aDogMVxuICB9XG59O1xuXG4vLyBGYWxzZSBwb3NpdGl2ZTogd2UgYXJlIHVzaW5nIGBzZXRUaW1lb3V0YCBhcyBhIHR5cGUuXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcmVzdHJpY3RlZC1nbG9iYWxzXG50eXBlIFRpbWVvdXQgPSBSZXR1cm5UeXBlPHR5cGVvZiBzZXRUaW1lb3V0PjtcblxuY29uc3QgVElNRV9UT19RVUVVRV9FUlJPUl9NRVNTQUdFID0gNTAwO1xuY29uc3QgVElNRV9UT19SRVNFVF9FUlJPUl9NRVNTQUdFID0gNTA7XG5cbi8vIFRoaXMgY29tcG9uZW50IGlzIG1hcmtlZCBhcyBpbnRlcm5hbCBiZWNhdXNlIGl0IGlzIG5vdCBmdWxseSBpbXBsZW1lbnRlZCBhbmQgaXMgbm90IHJlYWR5IHRvIGJlIGNvbnN1bWVkIHB1YmxpY2x5LlxuLy8gV2hlbiBpdCBpcyBkb25lLCBpdCBzaG91bGQgcHJvdmlkZSBhbmQgcmVwbGFjZSBhbGwgdGhlIGZ1bmN0aW9uYWxpdGllcyB3ZSBkaWQgaW4gUmVkdXgsIGluY2x1ZGluZyBidXQgbm90IGxpbWl0ZWQgdG86XG5cbi8vIC0gU3BlZWNoIGludGVyaW1zXG4vLyAtIE1haW50YWluIHRleHQgYm94IHZhbHVlXG4vLyAtIE11bHRpcGxlIDxTZW5kQm94Q29tcG9zZXI+IGluIGEgc2luZ2xlIFdlYiBDaGF0IGluc3RhbmNlXG4vLyAgICAtIFdlYiBkZXZzIHNob3VsZCBiZSBhYmxlIHRvIHB1dCBhbiBpbmRpdmlkdWFsIHNlbmQgYm94IGluc3RhbmNlIGludG8gYW4gYWN0aXZpdHlcbi8vICAgIC0gVGhlIHNlbmQgYm94IGluc3RhbmNlIGluIHRoZSBhY3Rpdml0eSwgc2hvdWxkIGJlIHNlcGFyYXRlZCBmcm9tIHRoZSBib3R0b21tb3N0IHNlbmQgYm94XG4vLyAgICAtIFRoZSB2YWx1ZWQgdHlwZWQgaW5zaWRlIHRoZSBhY3Rpdml0eSwgc2hvdWxkIGJlIHNlcGFyYXRlZCBmcm9tIHRoZSB2YWx1ZSB0eXBlZCBpbnRvIHRoZSBib3R0b21tb3N0IHNlbmQgYm94XG5cbi8vIEluIHRoZSBvbGQgZGF5cywgd2UgdXNlIFJlZHV4IHRvIGtlZXAgdGhlIHNlbmQgYm94IHN0YXRlLlxuLy8gSG93ZXZlciwgd2hlbiB3ZWIgZGV2cyBwdXQgMiBzZW5kIGJveCBvbiB0aGVpciBwYWdlLCBpdCBtYWtlcyB0aGluZ3MgY29tcGxleCBiZWNhdXNlIGJvdGggc2VuZCBib3hlcyB3aWxsIGludGVyYWN0IHdpdGggZWFjaCBvdGhlci5cbi8vIFdlIHdvdWxkIHJhdGhlciBoYXZlIHRoZW0gc2VwYXJhdGUuIElmIHdlYiBkZXZzIHdhbnQgdGhlbSB0byBpbnRlcmFjdCB3aXRoIGVhY2ggb3RoZXIsIHRoZXkgd2lsbCBkbyB0aGUgd2lyaW5nIHRoZW1zZWx2ZXMuXG5cbnR5cGUgRXJyb3JNZXNzYWdlU3RyaW5nTWFwID0gUmVhZG9ubHlNYXA8U2VuZEVycm9yLCBzdHJpbmc+O1xuXG4vLyBUT0RPOiBbUDJdIENvbXBsZXRlIHRoaXMgY29tcG9uZW50LlxuY29uc3QgU2VuZEJveENvbXBvc2VyID0gKHsgY2hpbGRyZW4gfTogUHJvcHNXaXRoQ2hpbGRyZW48e30+KSA9PiB7XG4gIGNvbnN0IFt7IGNsZWFyVGltZW91dCwgc2V0VGltZW91dCB9XSA9IHVzZVBvbnlmaWxsKCk7XG4gIGNvbnN0IFtjb25uZWN0aXZpdHlTdGF0dXNdID0gdXNlQ29ubmVjdGl2aXR5U3RhdHVzKCk7XG4gIGNvbnN0IFtlcnJvciwgc2V0RXJyb3JdID0gdXNlU3RhdGU8U2VuZEVycm9yIHwgZmFsc2U+KGZhbHNlKTtcbiAgY29uc3QgW3NlbmRCb3hWYWx1ZV0gPSB1c2VTZW5kQm94VmFsdWUoKTtcbiAgY29uc3QgYXBpU3VibWl0U2VuZEJveCA9IHVzZVN1Ym1pdFNlbmRCb3goKTtcbiAgY29uc3QgZm9jdXMgPSB1c2VGb2N1cygpO1xuICBjb25zdCBsb2NhbGl6ZSA9IHVzZUxvY2FsaXplcigpO1xuICBjb25zdCBzY3JvbGxUb0VuZCA9IHVzZVNjcm9sbFRvRW5kKCk7XG4gIGNvbnN0IHN0eWxlVG9FbW90aW9uT2JqZWN0ID0gdXNlU3R5bGVUb0Vtb3Rpb25PYmplY3QoKTtcbiAgY29uc3Qgc3VibWl0RXJyb3JNZXNzYWdlSWQgPSB1c2VVbmlxdWVJZCgnd2ViY2hhdF9fc2VuZC1ib3hfX2Vycm9yLW1lc3NhZ2UtaWQnKTtcbiAgY29uc3QgdGltZW91dFJlZiA9IHVzZVJlZjxyZWFkb25seSBbVGltZW91dCwgVGltZW91dF0gfCB1bmRlZmluZWQ+KHVuZGVmaW5lZCk7XG5cbiAgY29uc3QgZXJyb3JNZXNzYWdlU3RyaW5nTWFwID0gdXNlTWVtbzxFcnJvck1lc3NhZ2VTdHJpbmdNYXA+KFxuICAgICgpID0+XG4gICAgICBPYmplY3QuZnJlZXplKFxuICAgICAgICBuZXcgTWFwPFNlbmRFcnJvciwgc3RyaW5nPigpXG4gICAgICAgICAgLnNldCgnZW1wdHknLCBsb2NhbGl6ZSgnU0VORF9CT1hfSVNfRU1QVFlfVE9PTFRJUF9BTFQnKSlcbiAgICAgICAgICAvLyBUT0RPOiBbUDBdIFdlIHNob3VsZCBhZGQgYSBuZXcgc3RyaW5nIGZvciBcIkNhbm5vdCBzZW5kIG1lc3NhZ2Ugd2hpbGUgb2ZmbGluZS5cIlxuICAgICAgICAgIC5zZXQoJ29mZmxpbmUnLCBsb2NhbGl6ZSgnQ09OTkVDVElWSVRZX1NUQVRVU19BTFRfRkFUQUwnKSlcbiAgICAgICksXG4gICAgW2xvY2FsaXplXVxuICApO1xuICBjb25zdCBmb2N1c1JlZiA9IHVzZVJlZkZyb20oZm9jdXMpO1xuICBjb25zdCBzY3JvbGxUb0VuZFJlZiA9IHVzZVJlZkZyb20oc2Nyb2xsVG9FbmQpO1xuICBjb25zdCBzZXRFcnJvclJlZiA9IHVzZVJlZjx0eXBlb2Ygc2V0RXJyb3IgfCB1bmRlZmluZWQ+KHNldEVycm9yKTtcbiAgY29uc3Qgc3VibWl0RXJyb3JNZXNzYWdlQ2xhc3NOYW1lID0gc3R5bGVUb0Vtb3Rpb25PYmplY3QoU1VCTUlUX0VSUk9SX01FU1NBR0VfU1RZTEUpICsgJyc7XG4gIGNvbnN0IHN1Ym1pdEVycm9yTWVzc2FnZUlkU3RhdGUgPSB1c2VNZW1vPHJlYWRvbmx5IFtzdHJpbmcgfCB1bmRlZmluZWRdPihcbiAgICAoKSA9PiBPYmplY3QuZnJlZXplKFtlcnJvciA/IHN1Ym1pdEVycm9yTWVzc2FnZUlkIDogdW5kZWZpbmVkXSkgYXMgcmVhZG9ubHkgW3N0cmluZyB8IHVuZGVmaW5lZF0sXG4gICAgW2Vycm9yLCBzdWJtaXRFcnJvck1lc3NhZ2VJZF1cbiAgKTtcblxuICBzZXRFcnJvclJlZi5jdXJyZW50ID0gc2V0RXJyb3I7XG5cbiAgY29uc3Qgc3VibWl0RXJyb3JSZWYgPSB1c2VSZWZGcm9tPCdlbXB0eScgfCAnb2ZmbGluZScgfCB1bmRlZmluZWQ+KFxuICAgIGNvbm5lY3Rpdml0eVN0YXR1cyAhPT0gJ2Nvbm5lY3RlZCcgJiYgY29ubmVjdGl2aXR5U3RhdHVzICE9PSAncmVjb25uZWN0ZWQnXG4gICAgICA/ICdvZmZsaW5lJ1xuICAgICAgOiAhc2VuZEJveFZhbHVlXG4gICAgICA/ICdlbXB0eSdcbiAgICAgIDogdW5kZWZpbmVkXG4gICk7XG5cbiAgY29uc3Qgc3VibWl0ID0gdXNlQ2FsbGJhY2s8Q29udGV4dFR5cGVbJ3N1Ym1pdCddPihcbiAgICAoeyBzZXRGb2N1cyB9ID0ge30pID0+IHtcbiAgICAgIChzZXRGb2N1cyA9PT0gJ21haW4nIHx8IHNldEZvY3VzID09PSAnc2VuZEJveCcgfHwgc2V0Rm9jdXMgPT09ICdzZW5kQm94V2l0aG91dEtleWJvYXJkJykgJiZcbiAgICAgICAgZm9jdXNSZWYuY3VycmVudD8uKHNldEZvY3VzID09PSAnbWFpbicgfHwgc2V0Rm9jdXMgPT09ICdzZW5kQm94JyA/IHNldEZvY3VzIDogJ3NlbmRCb3hXaXRob3V0S2V5Ym9hcmQnKTtcblxuICAgICAgY29uc3QgeyBjdXJyZW50OiBzdWJtaXRFcnJvciB9ID0gc3VibWl0RXJyb3JSZWY7XG5cbiAgICAgIGlmIChzdWJtaXRFcnJvcikge1xuICAgICAgICB0aW1lb3V0UmVmLmN1cnJlbnQgJiYgdGltZW91dFJlZi5jdXJyZW50LmZvckVhY2goY2xlYXJUaW1lb3V0KTtcblxuICAgICAgICBzZXRFcnJvclJlZi5jdXJyZW50Py4oZmFsc2UpO1xuXG4gICAgICAgIHRpbWVvdXRSZWYuY3VycmVudCA9IE9iamVjdC5mcmVlemUoW1xuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gc2V0RXJyb3JSZWYuY3VycmVudD8uKHN1Ym1pdEVycm9yKSwgVElNRV9UT19SRVNFVF9FUlJPUl9NRVNTQUdFKSxcbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHNldEVycm9yUmVmLmN1cnJlbnQ/LihmYWxzZSksIFRJTUVfVE9fUVVFVUVfRVJST1JfTUVTU0FHRSlcbiAgICAgICAgXSkgYXMgcmVhZG9ubHkgW1RpbWVvdXQsIFRpbWVvdXRdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc2Nyb2xsVG9FbmRSZWYuY3VycmVudD8uKCk7XG4gICAgICAgIGFwaVN1Ym1pdFNlbmRCb3goKTtcbiAgICAgIH1cbiAgICB9LFxuICAgIFthcGlTdWJtaXRTZW5kQm94LCBjbGVhclRpbWVvdXQsIGZvY3VzUmVmLCBzY3JvbGxUb0VuZFJlZiwgc2V0RXJyb3JSZWYsIHNldFRpbWVvdXQsIHN1Ym1pdEVycm9yUmVmLCB0aW1lb3V0UmVmXVxuICApO1xuXG4gIHVzZUVmZmVjdChcbiAgICAvLyBQcmV2ZW50IGBzZXRUaW1lb3V0KClgIGZyb20gZmlyaW5nIGFmdGVyIHVubW91bnQuXG4gICAgKCkgPT4gKCkgPT4ge1xuICAgICAgc2V0RXJyb3JSZWYuY3VycmVudCA9IHVuZGVmaW5lZDtcbiAgICB9LFxuICAgIFtzZXRFcnJvclJlZl1cbiAgKTtcblxuICBjb25zdCBjb250ZXh0ID0gdXNlTWVtbyhcbiAgICAoKSA9PiAoe1xuICAgICAgc3VibWl0LFxuICAgICAgc3VibWl0RXJyb3JNZXNzYWdlSWRTdGF0ZVxuICAgIH0pLFxuICAgIFtzdWJtaXQsIHN1Ym1pdEVycm9yTWVzc2FnZUlkU3RhdGVdXG4gICk7XG5cbiAgcmV0dXJuIChcbiAgICA8U2VuZEJveENvbnRleHQuUHJvdmlkZXIgdmFsdWU9e2NvbnRleHR9PlxuICAgICAge2NoaWxkcmVufVxuICAgICAgPHNwYW5cbiAgICAgICAgY2xhc3NOYW1lPXtjbGFzc05hbWVzKCd3ZWJjaGF0X19zdWJtaXQtZXJyb3ItbWVzc2FnZScsIHN1Ym1pdEVycm9yTWVzc2FnZUNsYXNzTmFtZSl9XG4gICAgICAgIC8vIFwiaWRcIiBpcyByZXF1aXJlZCBmb3IgXCJhcmlhLWVycm9ybWVzc2FnZVwiIGFzIElEUkVGLlxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QvZm9yYmlkLWRvbS1wcm9wc1xuICAgICAgICBpZD17c3VibWl0RXJyb3JNZXNzYWdlSWR9XG4gICAgICAgIHJvbGU9XCJhbGVydFwiXG4gICAgICA+XG4gICAgICAgIHtlcnJvciA/IGVycm9yTWVzc2FnZVN0cmluZ01hcC5nZXQoZXJyb3IpIDogJyd9XG4gICAgICA8L3NwYW4+XG4gICAgPC9TZW5kQm94Q29udGV4dC5Qcm92aWRlcj5cbiAgKTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IFNlbmRCb3hDb21wb3NlcjtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBS0EsSUFBUUEscUJBQVIsR0FBZ0dDLDZCQUFoRyxDQUFRRCxxQkFBUjtBQUFBLElBQStCRSxZQUEvQixHQUFnR0QsNkJBQWhHLENBQStCQyxZQUEvQjtBQUFBLElBQTZDQyxXQUE3QyxHQUFnR0YsNkJBQWhHLENBQTZDRSxXQUE3QztBQUFBLElBQTBEQyxlQUExRCxHQUFnR0gsNkJBQWhHLENBQTBERyxlQUExRDtBQUFBLElBQTJFQyxnQkFBM0UsR0FBZ0dKLDZCQUFoRyxDQUEyRUksZ0JBQTNFO0FBRUEsSUFBTUMsMEJBQTBCLEdBQUc7RUFDakMsbUNBQW1DO0lBQ2pDO0lBQ0FDLEtBQUssRUFBRSxhQUYwQjtJQUdqQ0MsTUFBTSxFQUFFLENBSHlCO0lBSWpDQyxRQUFRLEVBQUUsUUFKdUI7SUFLakNDLFFBQVEsRUFBRSxVQUx1QjtJQU1qQztJQUNBO0lBQ0E7SUFDQTtJQUNBO0lBQ0FDLEdBQUcsRUFBRSxDQVg0QjtJQVlqQ0MsVUFBVSxFQUFFLFFBWnFCO0lBYWpDQyxLQUFLLEVBQUU7RUFiMEI7QUFERixDQUFuQyxDLENBa0JBO0FBQ0E7O0FBR0EsSUFBTUMsMkJBQTJCLEdBQUcsR0FBcEM7QUFDQSxJQUFNQywyQkFBMkIsR0FBRyxFQUFwQyxDLENBRUE7QUFDQTtBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUVBO0FBQ0E7QUFDQTs7QUFJQTtBQUNBLElBQU1DLGVBQWUsR0FBRyxTQUFs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