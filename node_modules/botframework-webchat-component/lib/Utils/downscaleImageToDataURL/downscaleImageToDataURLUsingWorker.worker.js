"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

/* eslint object-shorthand: "off" */

/* eslint prefer-destructuring: "off" */

/* eslint prefer-arrow-callback: "off" */
// This file is the entrypoint of Web Worker and is minimally transpiled through Babel.
// Do not include any dependencies here because they will not be bundled.
// This file will also get loaded by IE11, please make sure you hand-transpile it correctly.
function _default() {
  function blobToDataURL(blob) {
    return new Promise(function (resolve, reject) {
      const reader = new FileReader();

      reader.onerror = function (event) {
        reject(event.error || new Error(event.message));
      };

      reader.onloadend = function () {
        resolve(reader.result);
      };

      reader.readAsDataURL(blob);
    });
  }

  function keepAspectRatio(width, height, maxWidth, maxHeight) {
    if (width < maxWidth && height < maxHeight) {
      // Photo is smaller than both maximum dimensions, take it as-is
      return {
        height: height,
        width: width
      };
    }

    const aspectRatio = width / height;

    if (aspectRatio > maxWidth / maxHeight) {
      // Photo is wider than maximum dimension, downscale it based on maxWidth.
      return {
        height: maxWidth / aspectRatio,
        width: maxWidth
      };
    } // Photo is taller than maximum dimension, downscale it based on maxHeight.


    return {
      height: maxHeight,
      width: maxHeight * aspectRatio
    };
  }

  onmessage = function (event) {
    const data = event.data;
    const arrayBuffer = data.arrayBuffer;
    const maxHeight = data.maxHeight;
    const maxWidth = data.maxWidth;
    const type = data.type;
    const quality = data.quality;
    const port = event.ports[0];
    return Promise.resolve().then(function () {
      return createImageBitmap(new Blob([arrayBuffer], {
        resizeQuality: 'high'
      }));
    }).then(function (imageBitmap) {
      const dimension = keepAspectRatio(imageBitmap.width, imageBitmap.height, maxWidth, maxHeight);
      const height = dimension.height;
      const width = dimension.width;
      const offscreenCanvas = new OffscreenCanvas(width, height);
      const context = offscreenCanvas.getContext('2d');
      context.drawImage(imageBitmap, 0, 0, width, height); // Firefox quirks: 68.0.1 call named OffscreenCanvas.convertToBlob as OffscreenCanvas.toBlob.

      const convertToBlob = (offscreenCanvas.convertToBlob || offscreenCanvas.toBlob).bind(offscreenCanvas);
      return convertToBlob({
        type: type,
        quality: quality
      });
    }).then(function (blob) {
      return blobToDataURL(blob);
    }).then(function (dataURL) {
      return port.postMessage({
        result: dataURL
      });
    }).catch(function (err) {
      console.error(err);
      port.postMessage({
        error: {
          message: err.message,
          stack: err.stack
        }
      });
    });
  };

  postMessage('ready');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJibG9iVG9EYXRhVVJMIiwiYmxvYiIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwicmVhZGVyIiwiRmlsZVJlYWRlciIsIm9uZXJyb3IiLCJldmVudCIsImVycm9yIiwiRXJyb3IiLCJtZXNzYWdlIiwib25sb2FkZW5kIiwicmVzdWx0IiwicmVhZEFzRGF0YVVSTCIsImtlZXBBc3BlY3RSYXRpbyIsIndpZHRoIiwiaGVpZ2h0IiwibWF4V2lkdGgiLCJtYXhIZWlnaHQiLCJhc3BlY3RSYXRpbyIsIm9ubWVzc2FnZSIsImRhdGEiLCJhcnJheUJ1ZmZlciIsInR5cGUiLCJxdWFsaXR5IiwicG9ydCIsInBvcnRzIiwidGhlbiIsImNyZWF0ZUltYWdlQml0bWFwIiwiQmxvYiIsInJlc2l6ZVF1YWxpdHkiLCJpbWFnZUJpdG1hcCIsImRpbWVuc2lvbiIsIm9mZnNjcmVlbkNhbnZhcyIsIk9mZnNjcmVlbkNhbnZhcyIsImNvbnRleHQiLCJnZXRDb250ZXh0IiwiZHJhd0ltYWdlIiwiY29udmVydFRvQmxvYiIsInRvQmxvYiIsImJpbmQiLCJkYXRhVVJMIiwicG9zdE1lc3NhZ2UiLCJjYXRjaCIsImVyciIsImNvbnNvbGUiLCJzdGFjayJdLCJzb3VyY2VSb290IjoiY29tcG9uZW50Oi8vLyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL1V0aWxzL2Rvd25zY2FsZUltYWdlVG9EYXRhVVJML2Rvd25zY2FsZUltYWdlVG9EYXRhVVJMVXNpbmdXb3JrZXIud29ya2VyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCBvYmplY3Qtc2hvcnRoYW5kOiBcIm9mZlwiICovXG4vKiBlc2xpbnQgcHJlZmVyLWRlc3RydWN0dXJpbmc6IFwib2ZmXCIgKi9cbi8qIGVzbGludCBwcmVmZXItYXJyb3ctY2FsbGJhY2s6IFwib2ZmXCIgKi9cblxuLy8gVGhpcyBmaWxlIGlzIHRoZSBlbnRyeXBvaW50IG9mIFdlYiBXb3JrZXIgYW5kIGlzIG1pbmltYWxseSB0cmFuc3BpbGVkIHRocm91Z2ggQmFiZWwuXG4vLyBEbyBub3QgaW5jbHVkZSBhbnkgZGVwZW5kZW5jaWVzIGhlcmUgYmVjYXVzZSB0aGV5IHdpbGwgbm90IGJlIGJ1bmRsZWQuXG5cbi8vIFRoaXMgZmlsZSB3aWxsIGFsc28gZ2V0IGxvYWRlZCBieSBJRTExLCBwbGVhc2UgbWFrZSBzdXJlIHlvdSBoYW5kLXRyYW5zcGlsZSBpdCBjb3JyZWN0bHkuXG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uICgpIHtcbiAgZnVuY3Rpb24gYmxvYlRvRGF0YVVSTChibG9iKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG5cbiAgICAgIHJlYWRlci5vbmVycm9yID0gZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgIHJlamVjdChldmVudC5lcnJvciB8fCBuZXcgRXJyb3IoZXZlbnQubWVzc2FnZSkpO1xuICAgICAgfTtcblxuICAgICAgcmVhZGVyLm9ubG9hZGVuZCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmVzb2x2ZShyZWFkZXIucmVzdWx0KTtcbiAgICAgIH07XG5cbiAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGJsb2IpO1xuICAgIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24ga2VlcEFzcGVjdFJhdGlvKHdpZHRoLCBoZWlnaHQsIG1heFdpZHRoLCBtYXhIZWlnaHQpIHtcbiAgICBpZiAod2lkdGggPCBtYXhXaWR0aCAmJiBoZWlnaHQgPCBtYXhIZWlnaHQpIHtcbiAgICAgIC8vIFBob3RvIGlzIHNtYWxsZXIgdGhhbiBib3RoIG1heGltdW0gZGltZW5zaW9ucywgdGFrZSBpdCBhcy1pc1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaGVpZ2h0OiBoZWlnaHQsXG4gICAgICAgIHdpZHRoOiB3aWR0aFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCBhc3BlY3RSYXRpbyA9IHdpZHRoIC8gaGVpZ2h0O1xuXG4gICAgaWYgKGFzcGVjdFJhdGlvID4gbWF4V2lkdGggLyBtYXhIZWlnaHQpIHtcbiAgICAgIC8vIFBob3RvIGlzIHdpZGVyIHRoYW4gbWF4aW11bSBkaW1lbnNpb24sIGRvd25zY2FsZSBpdCBiYXNlZCBvbiBtYXhXaWR0aC5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIGhlaWdodDogbWF4V2lkdGggLyBhc3BlY3RSYXRpbyxcbiAgICAgICAgd2lkdGg6IG1heFdpZHRoXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIFBob3RvIGlzIHRhbGxlciB0aGFuIG1heGltdW0gZGltZW5zaW9uLCBkb3duc2NhbGUgaXQgYmFzZWQgb24gbWF4SGVpZ2h0LlxuICAgIHJldHVybiB7XG4gICAgICBoZWlnaHQ6IG1heEhlaWdodCxcbiAgICAgIHdpZHRoOiBtYXhIZWlnaHQgKiBhc3BlY3RSYXRpb1xuICAgIH07XG4gIH1cblxuICBvbm1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICBjb25zdCBkYXRhID0gZXZlbnQuZGF0YTtcbiAgICBjb25zdCBhcnJheUJ1ZmZlciA9IGRhdGEuYXJyYXlCdWZmZXI7XG4gICAgY29uc3QgbWF4SGVpZ2h0ID0gZGF0YS5tYXhIZWlnaHQ7XG4gICAgY29uc3QgbWF4V2lkdGggPSBkYXRhLm1heFdpZHRoO1xuICAgIGNvbnN0IHR5cGUgPSBkYXRhLnR5cGU7XG4gICAgY29uc3QgcXVhbGl0eSA9IGRhdGEucXVhbGl0eTtcbiAgICBjb25zdCBwb3J0ID0gZXZlbnQucG9ydHNbMF07XG5cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIGNyZWF0ZUltYWdlQml0bWFwKG5ldyBCbG9iKFthcnJheUJ1ZmZlcl0sIHsgcmVzaXplUXVhbGl0eTogJ2hpZ2gnIH0pKTtcbiAgICAgIH0pXG4gICAgICAudGhlbihmdW5jdGlvbiAoaW1hZ2VCaXRtYXApIHtcbiAgICAgICAgY29uc3QgZGltZW5zaW9uID0ga2VlcEFzcGVjdFJhdGlvKGltYWdlQml0bWFwLndpZHRoLCBpbWFnZUJpdG1hcC5oZWlnaHQsIG1heFdpZHRoLCBtYXhIZWlnaHQpO1xuICAgICAgICBjb25zdCBoZWlnaHQgPSBkaW1lbnNpb24uaGVpZ2h0O1xuICAgICAgICBjb25zdCB3aWR0aCA9IGRpbWVuc2lvbi53aWR0aDtcbiAgICAgICAgY29uc3Qgb2Zmc2NyZWVuQ2FudmFzID0gbmV3IE9mZnNjcmVlbkNhbnZhcyh3aWR0aCwgaGVpZ2h0KTtcbiAgICAgICAgY29uc3QgY29udGV4dCA9IG9mZnNjcmVlbkNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xuXG4gICAgICAgIGNvbnRleHQuZHJhd0ltYWdlKGltYWdlQml0bWFwLCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTtcblxuICAgICAgICAvLyBGaXJlZm94IHF1aXJrczogNjguMC4xIGNhbGwgbmFtZWQgT2Zmc2NyZWVuQ2FudmFzLmNvbnZlcnRUb0Jsb2IgYXMgT2Zmc2NyZWVuQ2FudmFzLnRvQmxvYi5cbiAgICAgICAgY29uc3QgY29udmVydFRvQmxvYiA9IChvZmZzY3JlZW5DYW52YXMuY29udmVydFRvQmxvYiB8fCBvZmZzY3JlZW5DYW52YXMudG9CbG9iKS5iaW5kKG9mZnNjcmVlbkNhbnZhcyk7XG5cbiAgICAgICAgcmV0dXJuIGNvbnZlcnRUb0Jsb2IoeyB0eXBlOiB0eXBlLCBxdWFsaXR5OiBxdWFsaXR5IH0pO1xuICAgICAgfSlcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChibG9iKSB7XG4gICAgICAgIHJldHVybiBibG9iVG9EYXRhVVJMKGJsb2IpO1xuICAgICAgfSlcbiAgICAgIC50aGVuKGZ1bmN0aW9uIChkYXRhVVJMKSB7XG4gICAgICAgIHJldHVybiBwb3J0LnBvc3RNZXNzYWdlKHsgcmVzdWx0OiBkYXRhVVJMIH0pO1xuICAgICAgfSlcbiAgICAgIC5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcblxuICAgICAgICBwb3J0LnBvc3RNZXNzYWdlKHtcbiAgICAgICAgICBlcnJvcjoge1xuICAgICAgICAgICAgbWVzc2FnZTogZXJyLm1lc3NhZ2UsXG4gICAgICAgICAgICBzdGFjazogZXJyLnN0YWNrXG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICB9O1xuXG4gIHBvc3RNZXNzYWdlKCdyZWFkeScpO1xufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7QUFFQTtBQUNBO0FBRUE7QUFFZSxvQkFBWTtFQUN6QixTQUFTQSxhQUFULENBQXVCQyxJQUF2QixFQUE2QjtJQUMzQixPQUFPLElBQUlDLE9BQUosQ0FBWSxVQUFVQyxPQUFWLEVBQW1CQyxNQUFuQixFQUEyQjtNQUM1QyxNQUFNQyxNQUFNLEdBQUcsSUFBSUMsVUFBSixFQUFmOztNQUVBRCxNQUFNLENBQUNFLE9BQVAsR0FBaUIsVUFBVUMsS0FBVixFQUFpQjtRQUNoQ0osTUFBTSxDQUFDSSxLQUFLLENBQUNDLEtBQU4sSUFBZSxJQUFJQyxLQUFKLENBQVVGLEtBQUssQ0FBQ0csT0FBaEIsQ0FBaEIsQ0FBTjtNQUNELENBRkQ7O01BSUFOLE1BQU0sQ0FBQ08sU0FBUCxHQUFtQixZQUFZO1FBQzdCVCxPQUFPLENBQUNFLE1BQU0sQ0FBQ1EsTUFBUixDQUFQO01BQ0QsQ0FGRDs7TUFJQVIsTUFBTSxDQUFDUyxhQUFQLENBQXFCYixJQUFyQjtJQUNELENBWk0sQ0FBUDtFQWFEOztFQUVELFNBQVNjLGVBQVQsQ0FBeUJDLEtBQXpCLEVBQWdDQyxNQUFoQyxFQUF3Q0MsUUFBeEMsRUFBa0RDLFNBQWxELEVBQTZEO0lBQzNELElBQUlILEtBQUssR0FBR0UsUUFBUixJQUFvQkQsTUFBTSxHQUFHRSxTQUFqQyxFQUE0QztNQUMxQztNQUNBLE9BQU87UUFDTEYsTUFBTSxFQUFFQSxNQURIO1FBRUxELEtBQUssRUFBRUE7TUFGRixDQUFQO0lBSUQ7O0lBRUQsTUFBTUksV0FBVyxHQUFHSixLQUFLLEdBQUdD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