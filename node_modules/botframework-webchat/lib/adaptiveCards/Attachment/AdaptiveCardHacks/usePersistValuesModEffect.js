"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = usePersistValuesModEffect;

var _react = require("react");

var _useAdaptiveCardModEffect = _interopRequireDefault(require("./private/useAdaptiveCardModEffect"));

var _usePrevious = _interopRequireDefault(require("./private/usePrevious"));

/**
 * Gets all user-inputted values under a DOM node.
 *
 * We assume values are ID-ed. If not ID-ed (such as `<textarea>`), there will be only a single instance (no two `<textarea>`).
 */
function getUserValues(element) {
  if (!element) {
    return new Set();
  }

  return Array.from(element.querySelectorAll('input, option, textarea')).reduce(function (values, element) {
    if (element instanceof HTMLInputElement) {
      var type = element.type;

      if (type === 'checkbox' || type === 'radio') {
        element.checked && values.add(element.value);
      } else {
        // ASSUMPTION: We expect CardObject will NOT mix <input type="text"> with <input type="checkbox">.
        values.clear();
        values.add(element.value);
      }
    } else if (element instanceof HTMLOptionElement) {
      element.selected && values.add(element.value);
    } else {
      // ASSUMPTION: We expect CardObject will NOT mix <textarea> with <input type="checkbox">.
      values.clear();
      values.add(element.value);
    }

    return values;
  }, new Set());
}
/**
 * Set multiple user-inputted values under a DOM node.
 *
 * This function must be paired with `getUserValues`.
 */


function setUserValues(element, values) {
  if (!element) {
    return;
  } // If the element does not support multiple choices, say <input type="text"> or <textarea>, then, use the first value.


  var defaultValue = Array.from(values)[0] || '';
  element.querySelectorAll('input, option, textarea').forEach(function (element) {
    if (element instanceof HTMLInputElement) {
      var type = element.type;

      if (type === 'checkbox' || type === 'radio') {
        element.checked = values.has(element.value);
      } else {
        element.value = defaultValue;
      }
    } else if (element instanceof HTMLOptionElement) {
      element.selected = values.has(element.value);
    } else {
      element.value = defaultValue;
    }
  });
}
/**
 * Re-rendering: Current user-inputted values must be saved and restored on re-render.
 */


function usePersistValuesModEffect(adaptiveCard) {
  var prevAdaptiveCard = (0, _usePrevious.default)(adaptiveCard);
  var valuesMapRef = (0, _react.useRef)(new Map());
  prevAdaptiveCard === adaptiveCard || valuesMapRef.current.clear();
  var modder = (0, _react.useMemo)(function () {
    return function (adaptiveCard) {
      var valuesMap = valuesMapRef.current;
      adaptiveCard.getAllInputs().forEach(function (cardObject) {
        valuesMap.has(cardObject) && setUserValues(cardObject.renderedElement, valuesMap.get(cardObject));
      });
      return function () {
        valuesMapRef.current = adaptiveCard.getAllInputs().reduce(function (valuesMap, cardObject) {
          var value = getUserValues(cardObject.renderedElement);
          return typeof value !== 'undefined' ? valuesMap.set(cardObject, value) : valuesMap;
        }, new Map());
      };
    };
  }, [valuesMapRef]);
  return (0, _useAdaptiveCardModEffect.default)(modder, adaptiveCard);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJnZXRVc2VyVmFsdWVzIiwiZWxlbWVudCIsIlNldCIsIkFycmF5IiwiZnJvbSIsInF1ZXJ5U2VsZWN0b3JBbGwiLCJyZWR1Y2UiLCJ2YWx1ZXMiLCJIVE1MSW5wdXRFbGVtZW50IiwidHlwZSIsImNoZWNrZWQiLCJhZGQiLCJ2YWx1ZSIsImNsZWFyIiwiSFRNTE9wdGlvbkVsZW1lbnQiLCJzZWxlY3RlZCIsInNldFVzZXJWYWx1ZXMiLCJkZWZhdWx0VmFsdWUiLCJmb3JFYWNoIiwiaGFzIiwidXNlUGVyc2lzdFZhbHVlc01vZEVmZmVjdCIsImFkYXB0aXZlQ2FyZCIsInByZXZBZGFwdGl2ZUNhcmQiLCJ1c2VQcmV2aW91cyIsInZhbHVlc01hcFJlZiIsInVzZVJlZiIsIk1hcCIsImN1cnJlbnQiLCJtb2RkZXIiLCJ1c2VNZW1vIiwidmFsdWVzTWFwIiwiZ2V0QWxsSW5wdXRzIiwiY2FyZE9iamVjdCIsInJlbmRlcmVkRWxlbWVudCIsImdldCIsInNldCIsInVzZUFkYXB0aXZlQ2FyZE1vZEVmZmVjdCJdLCJzb3VyY2VSb290IjoiYnVuZGxlOi8vLyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2FkYXB0aXZlQ2FyZHMvQXR0YWNobWVudC9BZGFwdGl2ZUNhcmRIYWNrcy91c2VQZXJzaXN0VmFsdWVzTW9kRWZmZWN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHVzZU1lbW8sIHVzZVJlZiB9IGZyb20gJ3JlYWN0JztcblxuaW1wb3J0IHVzZUFkYXB0aXZlQ2FyZE1vZEVmZmVjdCBmcm9tICcuL3ByaXZhdGUvdXNlQWRhcHRpdmVDYXJkTW9kRWZmZWN0JztcbmltcG9ydCB1c2VQcmV2aW91cyBmcm9tICcuL3ByaXZhdGUvdXNlUHJldmlvdXMnO1xuXG5pbXBvcnQgdHlwZSB7IEFkYXB0aXZlQ2FyZCwgQ2FyZE9iamVjdCB9IGZyb20gJ2FkYXB0aXZlY2FyZHMnO1xuXG4vKipcbiAqIEdldHMgYWxsIHVzZXItaW5wdXR0ZWQgdmFsdWVzIHVuZGVyIGEgRE9NIG5vZGUuXG4gKlxuICogV2UgYXNzdW1lIHZhbHVlcyBhcmUgSUQtZWQuIElmIG5vdCBJRC1lZCAoc3VjaCBhcyBgPHRleHRhcmVhPmApLCB0aGVyZSB3aWxsIGJlIG9ubHkgYSBzaW5nbGUgaW5zdGFuY2UgKG5vIHR3byBgPHRleHRhcmVhPmApLlxuICovXG5mdW5jdGlvbiBnZXRVc2VyVmFsdWVzKGVsZW1lbnQ6IEhUTUxFbGVtZW50IHwgdW5kZWZpbmVkKTogU2V0PHN0cmluZz4ge1xuICBpZiAoIWVsZW1lbnQpIHtcbiAgICByZXR1cm4gbmV3IFNldCgpO1xuICB9XG5cbiAgcmV0dXJuIEFycmF5LmZyb20oXG4gICAgZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdpbnB1dCwgb3B0aW9uLCB0ZXh0YXJlYScpIGFzIE5vZGVMaXN0T2Y8XG4gICAgICBIVE1MSW5wdXRFbGVtZW50IHwgSFRNTE9wdGlvbkVsZW1lbnQgfCBIVE1MVGV4dEFyZWFFbGVtZW50XG4gICAgPlxuICApLnJlZHVjZTxTZXQ8c3RyaW5nPj4oKHZhbHVlcywgZWxlbWVudCkgPT4ge1xuICAgIGlmIChlbGVtZW50IGluc3RhbmNlb2YgSFRNTElucHV0RWxlbWVudCkge1xuICAgICAgY29uc3QgeyB0eXBlIH0gPSBlbGVtZW50O1xuXG4gICAgICBpZiAodHlwZSA9PT0gJ2NoZWNrYm94JyB8fCB0eXBlID09PSAncmFkaW8nKSB7XG4gICAgICAgIGVsZW1lbnQuY2hlY2tlZCAmJiB2YWx1ZXMuYWRkKGVsZW1lbnQudmFsdWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gQVNTVU1QVElPTjogV2UgZXhwZWN0IENhcmRPYmplY3Qgd2lsbCBOT1QgbWl4IDxpbnB1dCB0eXBlPVwidGV4dFwiPiB3aXRoIDxpbnB1dCB0eXBlPVwiY2hlY2tib3hcIj4uXG4gICAgICAgIHZhbHVlcy5jbGVhcigpO1xuICAgICAgICB2YWx1ZXMuYWRkKGVsZW1lbnQudmFsdWUpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZWxlbWVudCBpbnN0YW5jZW9mIEhUTUxPcHRpb25FbGVtZW50KSB7XG4gICAgICBlbGVtZW50LnNlbGVjdGVkICYmIHZhbHVlcy5hZGQoZWxlbWVudC52YWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEFTU1VNUFRJT046IFdlIGV4cGVjdCBDYXJkT2JqZWN0IHdpbGwgTk9UIG1peCA8dGV4dGFyZWE+IHdpdGggPGlucHV0IHR5cGU9XCJjaGVja2JveFwiPi5cbiAgICAgIHZhbHVlcy5jbGVhcigpO1xuICAgICAgdmFsdWVzLmFkZChlbGVtZW50LnZhbHVlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdmFsdWVzO1xuICB9LCBuZXcgU2V0KCkpO1xufVxuXG4vKipcbiAqIFNldCBtdWx0aXBsZSB1c2VyLWlucHV0dGVkIHZhbHVlcyB1bmRlciBhIERPTSBub2RlLlxuICpcbiAqIFRoaXMgZnVuY3Rpb24gbXVzdCBiZSBwYWlyZWQgd2l0aCBgZ2V0VXNlclZhbHVlc2AuXG4gKi9cbmZ1bmN0aW9uIHNldFVzZXJWYWx1ZXMoZWxlbWVudDogSFRNTEVsZW1lbnQgfCB1bmRlZmluZWQsIHZhbHVlczogU2V0PHN0cmluZz4pOiB2b2lkIHtcbiAgaWYgKCFlbGVtZW50KSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLy8gSWYgdGhlIGVsZW1lbnQgZG9lcyBub3Qgc3VwcG9ydCBtdWx0aXBsZSBjaG9pY2VzLCBzYXkgPGlucHV0IHR5cGU9XCJ0ZXh0XCI+IG9yIDx0ZXh0YXJlYT4sIHRoZW4sIHVzZSB0aGUgZmlyc3QgdmFsdWUuXG4gIGNvbnN0IGRlZmF1bHRWYWx1ZSA9IEFycmF5LmZyb20odmFsdWVzKVswXSB8fCAnJztcblxuICAoXG4gICAgZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdpbnB1dCwgb3B0aW9uLCB0ZXh0YXJlYScpIGFzIE5vZGVMaXN0T2Y8XG4gICAgICBIVE1MSW5wdXRFbGVtZW50IHwgSFRNTE9wdGlvbkVsZW1lbnQgfCBIVE1MVGV4dEFyZWFFbGVtZW50XG4gICAgPlxuICApLmZvckVhY2goZWxlbWVudCA9PiB7XG4gICAgaWYgKGVsZW1lbnQgaW5zdGFuY2VvZiBIVE1MSW5wdXRFbGVtZW50KSB7XG4gICAgICBjb25zdCB7IHR5cGUgfSA9IGVsZW1lbnQ7XG5cbiAgICAgIGlmICh0eXBlID09PSAnY2hlY2tib3gnIHx8IHR5cGUgPT09ICdyYWRpbycpIHtcbiAgICAgICAgZWxlbWVudC5jaGVja2VkID0gdmFsdWVzLmhhcyhlbGVtZW50LnZhbHVlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGVsZW1lbnQudmFsdWUgPSBkZWZhdWx0VmFsdWU7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChlbGVtZW50IGluc3RhbmNlb2YgSFRNTE9wdGlvbkVsZW1lbnQpIHtcbiAgICAgIGVsZW1lbnQuc2VsZWN0ZWQgPSB2YWx1ZXMuaGFzKGVsZW1lbnQudmFsdWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBlbGVtZW50LnZhbHVlID0gZGVmYXVsdFZhbHVlO1xuICAgIH1cbiAgfSk7XG59XG5cbi8qKlxuICogUmUtcmVuZGVyaW5nOiBDdXJyZW50IHVzZXItaW5wdXR0ZWQgdmFsdWVzIG11c3QgYmUgc2F2ZWQgYW5kIHJlc3RvcmVkIG9uIHJlLXJlbmRlci5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gdXNlUGVyc2lzdFZhbHVlc01vZEVmZmVjdChhZGFwdGl2ZUNhcmQ6IEFkYXB0aXZlQ2FyZCkge1xuICBjb25zdCBwcmV2QWRhcHRpdmVDYXJkID0gdXNlUHJldmlvdXMoYWRhcHRpdmVDYXJkKTtcbiAgY29uc3QgdmFsdWVzTWFwUmVmID0gdXNlUmVmPE1hcDxDYXJkT2JqZWN0LCBTZXQ8c3RyaW5nPj4+KG5ldyBNYXAoKSk7XG5cbiAgcHJldkFkYXB0aXZlQ2FyZCA9PT0gYWRhcHRpdmVDYXJkIHx8IHZhbHVlc01hcFJlZi5jdXJyZW50LmNsZWFyKCk7XG5cbiAgY29uc3QgbW9kZGVyID0gdXNlTWVtbyhcbiAgICAoKSA9PiAoYWRhcHRpdmVDYXJkOiBBZGFwdGl2ZUNhcmQpID0+IHtcbiAgICAgIGNvbnN0IHsgY3VycmVudDogdmFsdWVzTWFwIH0gPSB2YWx1ZXNNYXBSZWY7XG5cbiAgICAgIGFkYXB0aXZlQ2FyZC5nZXRBbGxJbnB1dHMoKS5mb3JFYWNoKGNhcmRPYmplY3QgPT4ge1xuICAgICAgICB2YWx1ZXNNYXAuaGFzKGNhcmRPYmplY3QpICYmIHNldFVzZXJWYWx1ZXMoY2FyZE9iamVjdC5yZW5kZXJlZEVsZW1lbnQsIHZhbHVlc01hcC5nZXQoY2FyZE9iamVjdCkpO1xuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgIHZhbHVlc01hcFJlZi5jdXJyZW50ID0gYWRhcHRpdmVDYXJkXG4gICAgICAgICAgLmdldEFsbElucHV0cygpXG4gICAgICAgICAgLnJlZHVjZTxNYXA8Q2FyZE9iamVjdCwgU2V0PHN0cmluZz4+PigodmFsdWVzTWFwLCBjYXJkT2JqZWN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGdldFVzZXJWYWx1ZXMoY2FyZE9iamVjdC5yZW5kZXJlZEVsZW1lbnQpO1xuXG4gICAgICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJyA/IHZhbHVlc01hcC5zZXQoY2FyZE9iamVjdCwgdmFsdWUpIDogdmFsdWVzTWFwO1xuICAgICAgICAgIH0sIG5ldyBNYXAoKSk7XG4gICAgICB9O1xuICAgIH0sXG4gICAgW3ZhbHVlc01hcFJlZl1cbiAgKTtcblxuICByZXR1cm4gdXNlQWRhcHRpdmVDYXJkTW9kRWZmZWN0KG1vZGRlciwgYWRhcHRpdmVDYXJkKTtcbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBRUE7O0FBQ0E7O0FBSUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVNBLGFBQVQsQ0FBdUJDLE9BQXZCLEVBQXNFO0VBQ3BFLElBQUksQ0FBQ0EsT0FBTCxFQUFjO0lBQ1osT0FBTyxJQUFJQyxHQUFKLEVBQVA7RUFDRDs7RUFFRCxPQUFPQyxLQUFLLENBQUNDLElB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