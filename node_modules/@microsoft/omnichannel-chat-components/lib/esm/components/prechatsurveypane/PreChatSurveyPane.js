import * as AdaptiveCards from "adaptivecards";
import { ElementType, EventNames } from "../../common/Constants";
import { Stack } from "@fluentui/react";
import React, { useCallback } from "react";
import { addNoreferrerNoopenerTag, broadcastError, getInputValuesFromAdaptiveCard } from "../../common/utils";
import { BroadcastService } from "../../services/BroadcastService";
import { defaultPreChatSurveyPaneACContainerStyles } from "./common/defaultProps/defaultStyles/defaultPreChatSurveyPaneACContainerStyles";
import { defaultPreChatSurveyPaneControlProps } from "./common/defaultProps/defaultPreChatSurveyPaneControlProps";
import { defaultPreChatSurveyPaneGeneralStyles } from "./common/defaultProps/defaultStyles/defaultPreChatSurveyPaneGeneralStyles";
import { defaultPreChatSurveyPaneStyles } from "./common/defaultProps/defaultStyles/defaultPreChatSurveyPaneStyles";

function PreChatSurveyPane(props) {
  var _props$controlProps, _props$styleProps, _props$styleProps2, _props$styleProps3, _props$styleProps3$cu, _props$styleProps4, _props$styleProps4$cu, _props$styleProps5, _props$styleProps5$cu, _props$styleProps6, _props$styleProps6$cu, _props$styleProps7, _props$styleProps7$cu, _props$styleProps8, _props$styleProps8$cu, _props$styleProps9, _props$styleProps9$cu, _defaultPreChatSurvey, _props$styleProps10, _props$styleProps10$c, _defaultPreChatSurvey2, _props$styleProps11, _props$styleProps11$c, _props$styleProps12, _props$styleProps12$c, _defaultPreChatSurvey3, _props$styleProps13, _props$styleProps13$c, _defaultPreChatSurvey4, _props$styleProps14, _props$styleProps14$c, _props$styleProps15, _props$styleProps15$c, _defaultPreChatSurvey5, _props$styleProps16, _props$styleProps16$c, _defaultPreChatSurvey6, _props$styleProps17, _props$styleProps17$c, _defaultPreChatSurvey7, _props$styleProps18, _props$styleProps18$c, _defaultPreChatSurvey8, _props$styleProps19, _props$styleProps19$c, _defaultPreChatSurvey9, _props$styleProps20, _props$styleProps20$c, _defaultPreChatSurvey10, _props$styleProps21, _props$styleProps21$c, _defaultPreChatSurvey11, _props$controlProps6, _props$controlProps7, _props$controlProps8;

  const elementId = ((_props$controlProps = props.controlProps) === null || _props$controlProps === void 0 ? void 0 : _props$controlProps.id) ?? defaultPreChatSurveyPaneControlProps.id;
  let adpativeCardPayload;
  let adaptiveCardHostConfig;
  const containerStyles = {
    root: Object.assign({}, defaultPreChatSurveyPaneGeneralStyles, (_props$styleProps = props.styleProps) === null || _props$styleProps === void 0 ? void 0 : _props$styleProps.generalStyleProps)
  };
  const adaptiveCardContainerStyles = {
    root: Object.assign({}, defaultPreChatSurveyPaneACContainerStyles, (_props$styleProps2 = props.styleProps) === null || _props$styleProps2 === void 0 ? void 0 : _props$styleProps2.adaptiveCardContainerStyleProps)
  }; // Parse AC Host Config String input to JSON Object

  try {
    var _props$controlProps2;

    adaptiveCardHostConfig = JSON.parse(((_props$controlProps2 = props.controlProps) === null || _props$controlProps2 === void 0 ? void 0 : _props$controlProps2.adaptiveCardHostConfig) ?? defaultPreChatSurveyPaneControlProps.adaptiveCardHostConfig);
  } catch (error) {
    adaptiveCardHostConfig = "{}";
    broadcastError(elementId, error, "adaptiveCardHostConfig", ElementType.PreChatSurveyError);
  } // Parse AC Payload String input to JSON Object


  try {
    var _props$controlProps3;

    adpativeCardPayload = JSON.parse(((_props$controlProps3 = props.controlProps) === null || _props$controlProps3 === void 0 ? void 0 : _props$controlProps3.payload) ?? defaultPreChatSurveyPaneControlProps.payload);
  } catch (error) {
    adpativeCardPayload = "{}";
    broadcastError(elementId, error, "adpativeCardPayload", ElementType.PreChatSurveyError);
  } //On Submit Click Action


  const handleSubmitClick = useCallback(() => {
    var _props$controlProps4;

    const values = getInputValuesFromAdaptiveCard(adaptiveCard);

    if ((_props$controlProps4 = props.controlProps) !== null && _props$controlProps4 !== void 0 && _props$controlProps4.onSubmit) {
      var _props$controlProps5;

      const customEvent = {
        elementType: ElementType.PreChatSurveySubmitButton,
        elementId: elementId,
        eventName: EventNames.OnClick
      };
      BroadcastService.postMessage(customEvent);
      (_props$controlProps5 = props.controlProps) === null || _props$controlProps5 === void 0 ? void 0 : _props$controlProps5.onSubmit(values);
    }
  }, []); //Adaptive Card Initilializations

  AdaptiveCards.GlobalSettings.setTabIndexAtCardRoot = false;
  const adaptiveCard = new AdaptiveCards.AdaptiveCard();
  adaptiveCard.hostConfig = new AdaptiveCards.HostConfig(adaptiveCardHostConfig);
  adaptiveCard.parse(adpativeCardPayload);
  adaptiveCard.onExecuteAction = handleSubmitClick; // Render the card

  const renderedCard = adaptiveCard.render();
  addNoreferrerNoopenerTag(renderedCard);
  return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("style", null, `
            .ac-textBlock {
                font-size: ${(_props$styleProps3 = props.styleProps) === null || _props$styleProps3 === void 0 ? void 0 : (_props$styleProps3$cu = _props$styleProps3.customTextStyleProps) === null || _props$styleProps3$cu === void 0 ? void 0 : _props$styleProps3$cu.fontSize} !important;
                height: ${(_props$styleProps4 = props.styleProps) === null || _props$styleProps4 === void 0 ? void 0 : (_props$styleProps4$cu = _props$styleProps4.customTextStyleProps) === null || _props$styleProps4$cu === void 0 ? void 0 : _props$styleProps4$cu.height};
                padding-top: ${(_props$styleProps5 = props.styleProps) === null || _props$styleProps5 === void 0 ? void 0 : (_props$styleProps5$cu = _props$styleProps5.customTextStyleProps) === null || _props$styleProps5$cu === void 0 ? void 0 : _props$styleProps5$cu.paddingTop};
                overflow-wrap: break-word;
                white-space: normal !important;
            }
            .ac-textRun {
                font-size: ${(_props$styleProps6 = props.styleProps) === null || _props$styleProps6 === void 0 ? void 0 : (_props$styleProps6$cu = _props$styleProps6.customTextStyleProps) === null || _props$styleProps6$cu === void 0 ? void 0 : _props$styleProps6$cu.fontSize} !important;
                padding-top: ${(_props$styleProps7 = props.styleProps) === null || _props$styleProps7 === void 0 ? void 0 : (_props$styleProps7$cu = _props$styleProps7.customTextStyleProps) === null || _props$styleProps7$cu === void 0 ? void 0 : _props$styleProps7$cu.paddingTop};
            }
            .ac-input {
                margin-bottom: 6px;
            }
            .ac-input.ac-textInput {
                font-size: ${(_props$styleProps8 = props.styleProps) === null || _props$styleProps8 === void 0 ? void 0 : (_props$styleProps8$cu = _props$styleProps8.customTextInputStyleProps) === null || _props$styleProps8$cu === void 0 ? void 0 : _props$styleProps8$cu.fontSize};
                font-family: ${((_props$styleProps9 = props.styleProps) === null || _props$styleProps9 === void 0 ? void 0 : (_props$styleProps9$cu = _props$styleProps9.customTextInputStyleProps) === null || _props$styleProps9$cu === void 0 ? void 0 : _props$styleProps9$cu.fontFamily) ?? ((_defaultPreChatSurvey = defaultPreChatSurveyPaneStyles.customTextInputStyleProps) === null || _defaultPreChatSurvey === void 0 ? void 0 : _defaultPreChatSurvey.fontFamily)};
                height: ${((_props$styleProps10 = props.styleProps) === null || _props$styleProps10 === void 0 ? void 0 : (_props$styleProps10$c = _props$styleProps10.customTextInputStyleProps) === null || _props$styleProps10$c === void 0 ? void 0 : _props$styleProps10$c.height) ?? ((_defaultPreChatSurvey2 = defaultPreChatSurveyPaneStyles.customTextInputStyleProps) === null || _defaultPreChatSurvey2 === void 0 ? void 0 : _defaultPreChatSurvey2.height)};
                padding: 8px;
            }
            .ac-input.ac-textInput.ac-multiline {
                font-size: ${(_props$styleProps11 = props.styleProps) === null || _props$styleProps11 === void 0 ? void 0 : (_props$styleProps11$c = _props$styleProps11.customMultilineTextInputStyleProps) === null || _props$styleProps11$c === void 0 ? void 0 : _props$styleProps11$c.fontSize};
                font-family: ${((_props$styleProps12 = props.styleProps) === null || _props$styleProps12 === void 0 ? void 0 : (_props$styleProps12$c = _props$styleProps12.customMultilineTextInputStyleProps) === null || _props$styleProps12$c === void 0 ? void 0 : _props$styleProps12$c.fontFamily) ?? ((_defaultPreChatSurvey3 = defaultPreChatSurveyPaneStyles.customMultilineTextInputStyleProps) === null || _defaultPreChatSurvey3 === void 0 ? void 0 : _defaultPreChatSurvey3.fontFamily)};
                height: ${((_props$styleProps13 = props.styleProps) === null || _props$styleProps13 === void 0 ? void 0 : (_props$styleProps13$c = _props$styleProps13.customMultilineTextInputStyleProps) === null || _props$styleProps13$c === void 0 ? void 0 : _props$styleProps13$c.height) ?? ((_defaultPreChatSurvey4 = defaultPreChatSurveyPaneStyles.customMultilineTextInputStyleProps) === null || _defaultPreChatSurvey4 === void 0 ? void 0 : _defaultPreChatSurvey4.height)};
                resize: none;
            }
            .ac-input.ac-multichoiceInput {
                font-size: ${(_props$styleProps14 = props.styleProps) === null || _props$styleProps14 === void 0 ? void 0 : (_props$styleProps14$c = _props$styleProps14.customMultichoiceInputStyleProps) === null || _props$styleProps14$c === void 0 ? void 0 : _props$styleProps14$c.fontSize};
                font-family: ${((_props$styleProps15 = props.styleProps) === null || _props$styleProps15 === void 0 ? void 0 : (_props$styleProps15$c = _props$styleProps15.customMultichoiceInputStyleProps) === null || _props$styleProps15$c === void 0 ? void 0 : _props$styleProps15$c.fontFamily) ?? ((_defaultPreChatSurvey5 = defaultPreChatSurveyPaneStyles.customMultichoiceInputStyleProps) === null || _defaultPreChatSurvey5 === void 0 ? void 0 : _defaultPreChatSurvey5.fontFamily)};
                padding: 3px;
                padding-top: 7px;
                padding-bottom: 7px;
            }
            .ac-pushButton { 
                border: 1px solid #00000000;
                margin: 2px;
                height: ${((_props$styleProps16 = props.styleProps) === null || _props$styleProps16 === void 0 ? void 0 : (_props$styleProps16$c = _props$styleProps16.customButtonStyleProps) === null || _props$styleProps16$c === void 0 ? void 0 : _props$styleProps16$c.height) ?? ((_defaultPreChatSurvey6 = defaultPreChatSurveyPaneStyles.customButtonStyleProps) === null || _defaultPreChatSurvey6 === void 0 ? void 0 : _defaultPreChatSurvey6.height)};
                width: ${((_props$styleProps17 = props.styleProps) === null || _props$styleProps17 === void 0 ? void 0 : (_props$styleProps17$c = _props$styleProps17.customButtonStyleProps) === null || _props$styleProps17$c === void 0 ? void 0 : _props$styleProps17$c.width) ?? ((_defaultPreChatSurvey7 = defaultPreChatSurveyPaneStyles.customButtonStyleProps) === null || _defaultPreChatSurvey7 === void 0 ? void 0 : _defaultPreChatSurvey7.width)};
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
                font-size: ${((_props$styleProps18 = props.styleProps) === null || _props$styleProps18 === void 0 ? void 0 : (_props$styleProps18$c = _props$styleProps18.customButtonStyleProps) === null || _props$styleProps18$c === void 0 ? void 0 : _props$styleProps18$c.fontSize) ?? ((_defaultPreChatSurvey8 = defaultPreChatSurveyPaneStyles.customButtonStyleProps) === null || _defaultPreChatSurvey8 === void 0 ? void 0 : _defaultPreChatSurvey8.fontSize)};
                font-family: ${((_props$styleProps19 = props.styleProps) === null || _props$styleProps19 === void 0 ? void 0 : (_props$styleProps19$c = _props$styleProps19.customButtonStyleProps) === null || _props$styleProps19$c === void 0 ? void 0 : _props$styleProps19$c.fontFamily) ?? ((_defaultPreChatSurvey9 = defaultPreChatSurveyPaneStyles.customButtonStyleProps) === null || _defaultPreChatSurvey9 === void 0 ? void 0 : _defaultPreChatSurvey9.fontFamily)};
                color: ${((_props$styleProps20 = props.styleProps) === null || _props$styleProps20 === void 0 ? void 0 : (_props$styleProps20$c = _props$styleProps20.customButtonStyleProps) === null || _props$styleProps20$c === void 0 ? void 0 : _props$styleProps20$c.color) ?? ((_defaultPreChatSurvey10 = defaultPreChatSurveyPaneStyles.customButtonStyleProps) === null || _defaultPreChatSurvey10 === void 0 ? void 0 : _defaultPreChatSurvey10.color)};
                background-color: ${((_props$styleProps21 = props.styleProps) === null || _props$styleProps21 === void 0 ? void 0 : (_props$styleProps21$c = _props$styleProps21.customButtonStyleProps) === null || _props$styleProps21$c === void 0 ? void 0 : _props$styleProps21$c.backgroundColor) ?? ((_defaultPreChatSurvey11 = defaultPreChatSurveyPaneStyles.customButtonStyleProps) === null || _defaultPreChatSurvey11 === void 0 ? void 0 : _defaultPreChatSurvey11.backgroundColor)}; 
            }`), !((_props$controlProps6 = props.controlProps) !== null && _props$controlProps6 !== void 0 && _props$controlProps6.hidePreChatSurveyPane) && /*#__PURE__*/React.createElement(Stack, {
    id: elementId,
    tabIndex: -1,
    role: ((_props$controlProps7 = props.controlProps) === null || _props$controlProps7 === void 0 ? void 0 : _props$controlProps7.role) ?? defaultPreChatSurveyPaneControlProps.role,
    dir: ((_props$controlProps8 = props.controlProps) === null || _props$controlProps8 === void 0 ? void 0 : _props$controlProps8.dir) ?? defaultPreChatSurveyPaneControlProps.dir,
    styles: containerStyles
  }, /*#__PURE__*/React.createElement(Stack, {
    tabIndex: -1,
    styles: adaptiveCardContainerStyles
  }, /*#__PURE__*/React.createElement("div", {
    ref: n => {
      // Returns React element
      renderedCard && n && n.appendChild(renderedCard);
      n && n.childElementCount > 1 && n.lastChild && n.removeChild(n.lastChild); // Removes duplicates fix
    }
  }))));
}

export default PreChatSurveyPane;